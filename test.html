<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Booking Form</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script>
function initMapCallback() {
  if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
    console.log("Google Maps loaded successfully");
    setTimeout(initAC, 100);
  } else {
    console.log("Google Maps not available yet, retrying...");
    setTimeout(initMapCallback, 1000);
  }
}
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBECPPi3uRa4A5CQ7-zIvQ3ooJu3g9EQKg&libraries=places&callback=initMapCallback" async defer></script>
<style>
body,input,select,button{font-family:Arial,sans-serif}
body{margin:0;padding:0}
body[data-booking-type="hourly"] #passengers-container,
body[data-booking-type="hourly"] #kids-container {display: none !important;}
body[data-booking-type="hourly"] #luggage-container {display: none !important;}
html[data-booking-type="hourly"] #luggage-container {display: none !important;}
.remove-button {background-color: #444;border: none;border-radius: 50%;width: 20px;height: 20px;display: inline-flex;align-items: center;justify-content: center;margin-left: 8px;font-size: 12px;cursor: pointer;} .remove-button:hover {background-color: #666;}
.container{display:flex;max-width:1200px;margin:auto;padding:15px;justify-content:center;align-items:flex-start}
.booking-form{background:#111;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(255,255,255,.2);width:600px;display:flex;flex-wrap:wrap;justify-content:space-between;margin-right:20px}
.booking-form input:invalid{border-color:#a10000}
.booking-form input:focus{outline:0;border-color:#131313}
.booking-form label{color:#fff;width:100%}
.booking-form .form-group{width:48%}
.booking-form .form-group.full-width,.booking-form .form-group.full-width input,.booking-form .form-group.full-width select,#pickup,#dropoff,#stops-container input.autocomplete{width:100%!important}
.booking-form .form-group.full-width{margin-bottom:15px}
.booking-form input,.booking-form select,textarea{padding:10px;border:none;border-radius:5px;background:#222;color:#fff;width:100%;box-sizing:border-box}
.booking-form input::placeholder{color:#fff}
.booking-form button{background:#fff;color:#000;padding:10px;border:none;border-radius:5px;cursor:pointer;font-weight:700;width:100%;margin-top:10px}
.booking-form button:hover{background:#ccc}
.booking-type-selector{display:flex!important;width:100%;margin-bottom:20px;justify-content:center;border-radius:5px;overflow:hidden;background:#333}
.booking-type-btn{flex:1;padding:12px 15px;text-align:center;background:#333;color:#fff;border:none;cursor:pointer;font-weight:700;transition:.3s}
.booking-type-btn.active{background:#fff;color:#000}
.duration-container{width:100%;margin-bottom:20px}
.duration-row{display:flex;justify-content:space-between;align-items:center;gap:20px}
.duration-field{flex:1;display:flex;flex-direction:column}
.duration-field label{margin-bottom:12px;color:#fff;font-size:.9em;text-transform:uppercase;letter-spacing:1px;font-weight:500}
.duration-input-group{display:flex;align-items:center;border:none;overflow:hidden;background:#222;height:45px;box-shadow:0 4px 8px rgba(0,0,0,.3)}
.duration-btn{width:45px;height:45px;background:#000;color:#fff;border:none;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center}
.duration-input{flex:1;text-align:center;border:none;background:#222;color:#fff;font-weight:600;font-size:1.2em;width:60px;height:45px}
.duration-btn:hover{background:rgba(255,255,255,.15);color:#fff}
.duration-display{text-align:center;margin-top:15px;font-size:1.1em;color:#fff;background:rgba(0,0,0,.2);padding:10px;border-radius:20px;font-weight:500;letter-spacing:.5px;box-shadow:inset 0 2px 4px rgba(0,0,0,.2)}
.duration-display span{font-weight:700;font-size:1.2em;color:#fff}
#stops-container{margin:10px 0;width:100%}
.airport-requirement {background-color: #2c3e50;padding: 10px;margin: 5px 0 15px 0;border-radius: 5px;font-size: 0.9em;color: #fff;display: none;}
.airport-requirement.active {display: block;}
.airport-requirement i{color: #f39c12;margin-right: 5px;}
#airport-fields{background:transparent;width:100%;margin-top:10px;display:block}
#arrival-fields,#flight-type-container{display:none;width:100%;margin:15px 0}
#flight-type{padding:10px;border:none;border-radius:5px;background:#222;color:#fff;width:100%;cursor:pointer;font-size:inherit}
#flight-type:focus{outline:0;box-shadow:0 0 0 2px rgba(131,131,131,.3)}
#flight-type option{background:#222;color:#fff;padding:10px}
.right-container{width:600px;position:sticky;top:20px;display:flex;flex-direction:column;gap:20px}
#map-container {width: 100%;height: 600px;border-radius: 10px;overflow: hidden;box-shadow: 0 0 10px rgba(0,0,0,.3);position: relative;transition: height 0.3s ease;}
#map-frame {width: 100%;height: 100%;border: 0;transition: opacity 0.3s ease;background-color: #f2f2f2;display: block;}
#map-loading{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:5;opacity:0;transition:opacity 0.3s ease;pointer-events:none}
#map-spinner{border:5px solid #f3f3f3;border-top:5px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 2s linear infinite}
.hidden{display:none}
.error-field{border-color:#a10000!important}
.vehicle-disabled{opacity:.5;cursor:not-allowed}
.vehicle-disabled:hover{border:none}
.vehicle-selection{text-align:center;margin-top:20px;width:100%}
.vehicle{display:inline-block;width:45%;margin:10px;padding:10px;background:#222;border-radius:10px;cursor:pointer;text-align:center}
.vehicle img{width:100%;border-radius:10px}
.vehicle span{display:block;margin-top:10px;color:#fff;font-size:1.2em;font-weight:700}
/* New styles for collapsible details */
.price-summary {
  background: #333;
  border-radius: 5px;
  padding: 10px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
.price-summary:hover {
  background: #444;
}
.price-summary-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.more-details-toggle {
  color: #888;
  font-size: 0.9em;
  display: flex;
  align-items: center;
  gap: 5px;
}
.more-details-toggle i {
  transition: transform 0.3s ease;
}
.more-details-toggle.expanded i {
  transform: rotate(180deg);
}
.price-breakdown-details {
  background: #2a2a2a;
  border-radius: 5px;
  margin-top: 10px;
  overflow: hidden;
  transition: max-height 0.3s ease;
}
.price-breakdown-details.collapsed {
  max-height: 0;
}
.price-breakdown-details.expanded {
  max-height: 500px;
}
.price-breakdown-content {
  padding: 15px;
}
.price-loading{display: flex; align-items: center; justify-content: center; color: #fff; padding: 15px; font-style: italic;}
.price-loading i{margin-right: 10px; animation: spin 2s linear infinite;}
.price-ready{display: block;}
#price-breakdown{width:100%;display:block}
.price-details{color:#fff;margin:15px 0;padding:15px;background:#222;border-radius:5px;width:100%;box-sizing:border-box}
.price-details h3{color:#fff;margin:10px 0;padding-bottom:5px;border-bottom:1px solid #444}
.price-details .price-item{margin:5px 0;display:flex;justify-content:space-between}
.price-details .price-item i{margin-right:5px;width:18px;text-align:center}
.price-details .total{border-top:1px solid #444;margin-top:10px;padding-top:10px;font-weight:700;font-size:1.2em}
.selected{border:2px solid #fff}
#lo{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;justify-content:center;align-items:center;z-index:9999}
.loader{border:5px solid #f3f3f3;border-top:5px solid #3498db;border-radius:50%;width:50px;height:50px;animation:spin 2s linear infinite}
.pac-container{z-index:10000!important}
#redir{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10000;display:none;flex-direction:column;justify-content:center;align-items:center;text-align:center;color:#fff;padding:20px}
#redir h2{margin-bottom:20px;color:#4CAF50;font-size:28px}
#redir button{font-size:18px;padding:15px 25px;margin-top:20px;background:#4CAF50;color:#fff;border:none;border-radius:5px;cursor:pointer;font-weight:700}
#redir p{margin:10px 0;max-width:500px;font-size:16px;line-height:1.5}
#transfer-special-request,#hourly-itinerary{width:100%;min-height:150px;padding:15px;margin:5px 0;background:#222;color:#fff;border:1px solid #333;border-radius:8px;font-size:1.05em;resize:vertical;box-shadow:inset 0 2px 4px rgba(0,0,0,.3);transition:.3s}
#transfer-special-request:focus,#hourly-itinerary:focus{border-color:#555;box-shadow:inset 0 2px 8px rgba(100,100,100,.4);outline:none}
#transfer-special-request-container,#hourly-itinerary-container{margin:20px 0;width:100%}
.stop{position:relative;width:100%;margin-bottom:12px}
.stop input.autocomplete{width:calc(100% - 34px)!important;background:#222;color:#fff;border:none;border-radius:5px;padding:10px}
#stops-container+button{margin-top:5px;margin-bottom:15px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
#sm{color:#fff;background:#4CAF50;padding:10px;border-radius:5px;margin-top:20px;text-align:center;display:none}
@media(max-width:1260px){.container{flex-direction:column;align-items:center;padding:10px}.booking-form,.right-container{width:100%;max-width:600px;margin-right:0}.right-container{margin-top:20px}}
@media(max-width:1024px){body{font-size:16px}.container{padding:12px}.booking-form{padding:15px}.right-container{width:100%}#map-container{height:450px;max-height:65vh}.booking-form .form-group,.vehicle{width:100%}}
@media(max-width:480px){#map-container{height:350px}}
@media(orientation:landscape) and (max-height:500px){#map-container{height:300px}}
@media(max-width:1024px){#map-container{height: 450px;max-height: 65vh;}}
@media(max-width:768px){#map-container{height: 400px;max-height: 60vh;}}
@media(max-width:480px){#map-container{height: 350px;max-height: 50vh;}}
@media(orientation:landscape) and (max-height:600px) {#map-container {height: 300px;max-height: 70vh;}}
@media(orientation:landscape) and (max-height:450px) {#map-container{height: 250px;max-height: 60vh;}}
</style>
<script>
let routeData = null;
let stopCount = 0;
let lPDet={},mUTm=null,pIP=!1,mTNB=null,PR={
  BF:22.50,
  RM:4.00,
  PMN:1.00,
  PP:0,
  SFR:.05,
  TR:.0975,
  AF:0,
  HR:95,
  MR:95/60,
  SUV_BF:30,
  SUV_RM:5.35,
  SUV_PMN:1.00,
  SUV_HR:115,
  MIN_FARE:50.00,    // NUEVA: Tarifa mínima de $50
  MIN_DISTANCE:2.0   // NUEVA: Aplicar a viajes de 2 millas o menos
},mTNCs=["davidson","williamson","rutherford","wilson","sumner","robertson","cheatham","dickson","maury","marshall","bedford","coffee","cannon","smith","trousdale","macon","clay","jackson","putnam","dekalb","white","cumberland","warren","van buren","grundy","franklin","moore","lincoln","giles","lawrence","wayne","lewis","hickman","perry","humphreys"];

const POINT_TO_POINT_DISTANCE_PRICING = {
  ranges: [
    { min: 0, max: 2, sedanBaseFare: 76.00, suvBaseFare: 76.00 },
    { min: 3, max: 10, sedanBaseFare: 76.00, suvBaseFare: 76.00 },
    { min: 11, max: 15, sedanBaseFare: 86.00, suvBaseFare: 105.00 },
    { min: 16, max: 20, sedanBaseFare: 105.00, suvBaseFare: 129.00 },
    { min: 21, max: 30, sedanBaseFare: 119.00, suvBaseFare: 149.00 },
    { min: 31, max: 40, sedanBaseFare: 133.00, suvBaseFare: 167.00 }
  ],
  // Para distancias mayores a 40 millas, usar el último rango
  getBaseFareByDistance: function(miles, isSUV) {
    console.log(`=== CALCULANDO PRECIO BASE POINT-TO-POINT ===`);
    console.log(`Distancia: ${miles.toFixed(2)} millas`);
    console.log(`Vehículo: ${isSUV ? 'SUV' : 'Sedan'}`);
    
    for (let range of this.ranges) {
      if (miles >= range.min && miles <= range.max) {
        const baseFare = isSUV ? range.suvBaseFare : range.sedanBaseFare;
        console.log(`Rango encontrado: ${range.min}-${range.max} millas`);
        console.log(`Precio base aplicado: $${baseFare.toFixed(2)}`);
        console.log(`=============================================`);
        return baseFare;
      }
    }
    
    // Si es mayor a 40 millas, usar el último rango
    const lastRange = this.ranges[this.ranges.length - 1];
    const baseFare = isSUV ? lastRange.suvBaseFare : lastRange.sedanBaseFare;
    console.log(`Distancia > 40 millas, usando último rango`);
    console.log(`Precio base aplicado: $${baseFare.toFixed(2)}`);
    console.log(`=============================================`);
    return baseFare;
  }
};

const AREA_PRICING_CONFIG = {
  // Nivel 1: Donelson - Precio especial más bajo ($76/$76)
  donelson: {
    name: "Donelson",
    zipCodes: ["37214"],
    keywords: ["donelson", "airport", "nashville international airport", "bna", "music valley"],
    baseFare: 76.00,
    suvBaseFare: 76.00,
    level: 1
  },

  // Nivel 2: Precio medio-bajo ($81/$95)
  downtown_core: {
    name: "Downtown/Midtown/SoBro/Germantown/East Nashville",
    zipCodes: ["37201", "37203", "37219", "37206", "37213"],
    keywords: ["downtown", "midtown", "sobro", "germantown", "east nashville", 
               "music city center", "bridgestone arena", "nissan stadium", "broadway", "the gulch"],
    baseFare: 81.00,
    suvBaseFare: 95.00,
    level: 2
  },
  brentwood_north: {
    name: "Brentwood North",
    zipCodes: ["37027"],
    keywords: ["brentwood north", "brentwood"],
    baseFare: 81.00,
    suvBaseFare: 95.00,
    level: 2
  },
  green_hills: {
    name: "Green Hills",
    zipCodes: ["37215"],
    keywords: ["green hills", "mall at green hills", "hillsboro pike"],
    baseFare: 81.00,
    suvBaseFare: 95.00,
    level: 2
  },
  oak_hill: {
    name: "Oak Hill",
    zipCodes: ["37220"],
    keywords: ["oak hill"],
    baseFare: 81.00,
    suvBaseFare: 95.00,
    level: 2
  },
  west_end_vanderbilt: {
    name: "West End / Vanderbilt",
    zipCodes: ["37212"],
    keywords: ["west end", "vanderbilt", "vanderbilt university", "music row"],
    baseFare: 81.00,
    suvBaseFare: 95.00,
    level: 2
  },
  sylvan_park_charlotte: {
    name: "Sylvan Park / Charlotte",
    zipCodes: ["37209"],
    keywords: ["sylvan park", "charlotte", "charlotte avenue"],
    baseFare: 81.00,
    suvBaseFare: 95.00,
    level: 2
  },
  belle_meade: {
    name: "Belle Meade",
    zipCodes: ["37205"],
    keywords: ["belle meade", "harding pike"],
    baseFare: 81.00,
    suvBaseFare: 95.00,
    level: 2
  },
  forest_hills: {
    name: "Forest Hills",
    zipCodes: ["37215"],
    keywords: ["forest hills"],
    baseFare: 81.00,
    suvBaseFare: 95.00,
    level: 2
  },
  crieve_hall: {
    name: "Crieve Hall / South Nashville",
    zipCodes: ["37211"],
    keywords: ["crieve hall", "south nashville"],
    baseFare: 81.00,
    suvBaseFare: 95.00,
    level: 2
  },

  // Nivel 3: Precio medio ($90/$110)
  mt_juliet: {
    name: "Mt. Juliet",
    zipCodes: ["37122"],
    keywords: ["mt juliet", "mount juliet", "mt. juliet"],
    baseFare: 90.00,
    suvBaseFare: 110.00,
    level: 3
  },
  hermitage: {
    name: "Hermitage",
    zipCodes: ["37076"],
    keywords: ["hermitage"],
    baseFare: 90.00,
    suvBaseFare: 110.00,
    level: 3
  },
  bellevue: {
    name: "Bellevue",
    zipCodes: ["37221"],
    keywords: ["bellevue"],
    baseFare: 90.00,
    suvBaseFare: 110.00,
    level: 3
  },
  madison: {
    name: "Madison",
    zipCodes: ["37115"],
    keywords: ["madison"],
    baseFare: 90.00,
    suvBaseFare: 110.00,
    level: 3
  },
  inglewood: {
    name: "Inglewood",
    zipCodes: ["37216"],
    keywords: ["inglewood"],
    baseFare: 90.00,
    suvBaseFare: 110.00,
    level: 3
  },
  priest_lake_antioch: {
    name: "Priest Lake / Antioch",
    zipCodes: ["37217", "37013"],
    keywords: ["priest lake", "antioch"],
    baseFare: 90.00,
    suvBaseFare: 110.00,
    level: 3
  },
  bordeaux: {
    name: "Bordeaux",
    zipCodes: ["37218"],
    keywords: ["bordeaux"],
    baseFare: 90.00,
    suvBaseFare: 110.00,
    level: 3
  },
  old_hickory: {
    name: "Old Hickory",
    zipCodes: ["37138"],
    keywords: ["old hickory"],
    baseFare: 90.00,
    suvBaseFare: 110.00,
    level: 3
  },

  // Nivel 4: Precio medio-alto ($105/$129)
  hendersonville: {
    name: "Hendersonville",
    zipCodes: ["37075"],
    keywords: ["hendersonville"],
    baseFare: 105.00,
    suvBaseFare: 129.00,
    level: 4
  },
  nolensville: {
    name: "Nolensville",
    zipCodes: ["37135"],
    keywords: ["nolensville"],
    baseFare: 105.00,
    suvBaseFare: 129.00,
    level: 4
  },
  la_vergne: {
    name: "La Vergne",
    zipCodes: ["37086"],
    keywords: ["la vergne", "lavergne"],
    baseFare: 105.00,
    suvBaseFare: 129.00,
    level: 4
  },
  joelton: {
    name: "Joelton",
    zipCodes: ["37080"],
    keywords: ["joelton"],
    baseFare: 105.00,
    suvBaseFare: 129.00,
    level: 4
  },
  goodlettsville_davidson: {
    name: "Goodlettsville (Davidson side)",
    zipCodes: ["37072"],
    keywords: ["goodlettsville davidson", "goodlettsville"],
    baseFare: 105.00,
    suvBaseFare: 129.00,
    level: 4
  },
  ashland_city: {
    name: "Ashland City",
    zipCodes: ["37015"],
    keywords: ["ashland city"],
    baseFare: 105.00,
    suvBaseFare: 129.00,
    level: 4
  },
  kingston_springs: {
    name: "Kingston Springs",
    zipCodes: ["37082"],
    keywords: ["kingston springs"],
    baseFare: 105.00,
    suvBaseFare: 129.00,
    level: 4
  },
  pegram: {
    name: "Pegram",
    zipCodes: ["37143"],
    keywords: ["pegram"],
    baseFare: 105.00,
    suvBaseFare: 129.00,
    level: 4
  },

  // Nivel 5: Precio alto ($119/$143)
  franklin: {
    name: "Franklin",
    zipCodes: ["37064", "37067", "37069"],
    keywords: ["franklin"],
    baseFare: 119.00,
    suvBaseFare: 143.00,
    level: 5
  },
  lebanon: {
    name: "Lebanon",
    zipCodes: ["37087", "37090"],
    keywords: ["lebanon"],
    baseFare: 119.00,
    suvBaseFare: 143.00,
    level: 5
  },
  white_house: {
    name: "White House",
    zipCodes: ["37188"],
    keywords: ["white house"],
    baseFare: 119.00,
    suvBaseFare: 143.00,
    level: 5
  },
  pleasant_view: {
    name: "Pleasant View",
    zipCodes: ["37146"],
    keywords: ["pleasant view"],
    baseFare: 119.00,
    suvBaseFare: 143.00,
    level: 5
  },
  ridgetop: {
    name: "Ridgetop",
    zipCodes: ["37152"],
    keywords: ["ridgetop"],
    baseFare: 119.00,
    suvBaseFare: 143.00,
    level: 5
  },

  // Nivel 6: Precio muy alto ($124-138/$148-162)
  smyrna: {
    name: "Smyrna",
    zipCodes: ["37167"],
    keywords: ["smyrna"],
    baseFare: 124.00,
    suvBaseFare: 148.00,
    level: 6
  },
  gallatin: {
    name: "Gallatin",
    zipCodes: ["37066"],
    keywords: ["gallatin"],
    baseFare: 133.00,
    suvBaseFare: 157.00,
    level: 6
  },
  springfield: {
    name: "Springfield",
    zipCodes: ["37172"],
    keywords: ["springfield"],
    baseFare: 133.00,
    suvBaseFare: 157.00,
    level: 6
  },
  watertown: {
    name: "Watertown",
    zipCodes: ["37184"],
    keywords: ["watertown"],
    baseFare: 133.00,
    suvBaseFare: 157.00,
    level: 6
  },
  murfreesboro: {
    name: "Murfreesboro",
    zipCodes: ["37128", "37129", "37130"],
    keywords: ["murfreesboro"],
    baseFare: 138.00,
    suvBaseFare: 162.00,
    level: 6
  },

  // Nivel 7: Precio máximo ($152/$176)
  spring_hill: {
    name: "Spring Hill",
    zipCodes: ["37174"],
    keywords: ["spring hill"],
    baseFare: 152.00,
    suvBaseFare: 176.00,
    level: 7
  },
  thompsons_station: {
    name: "Thompson's Station",
    zipCodes: ["37179"],
    keywords: ["thompson station", "thompsons station", "thompson's station"],
    baseFare: 152.00,
    suvBaseFare: 176.00,
    level: 7
  },

  // Default (precio estándar original)
  default: {
    name: "Standard Area",
    baseFare: 22.50,  // Original PR.BF
    suvBaseFare: 30.00,  // Original PR.SUV_BF
    level: 0
  }
};



function extractZipCodeFromAddress(address) {
  if (!address) return null;
  
  // Buscar códigos postales de 5 dígitos
  const zipMatch = address.match(/\b\d{5}\b/);
  return zipMatch ? zipMatch[0] : null;
}

function detectAreaByZipCode(zipCode) {
  if (!zipCode) return null;
  
  console.log(`Buscando área por código postal: ${zipCode}`);
  
  for (const [areaKey, areaData] of Object.entries(AREA_PRICING_CONFIG)) {
    if (areaKey === 'default') continue;
    
    if (areaData.zipCodes.includes(zipCode)) {
      console.log(`Área detectada por ZIP ${zipCode}: ${areaData.name} (Nivel ${areaData.level})`);
      return areaKey;
    }
  }
  
  console.log(`No se encontró área específica para ZIP ${zipCode}`);
  return null;
}

function detectAreaByKeywords(address) {
  if (!address) return null;
  
  const addressLower = address.toLowerCase();
  console.log(`Buscando área por palabras clave en: "${addressLower}"`);
  
  // Ordenar por nivel de precio para dar prioridad a áreas más específicas
  const sortedAreas = Object.entries(AREA_PRICING_CONFIG)
    .filter(([key]) => key !== 'default')
    .sort(([,a], [,b]) => a.level - b.level);
  
  for (const [areaKey, areaData] of sortedAreas) {
    for (const keyword of areaData.keywords) {
      if (addressLower.includes(keyword.toLowerCase())) {
        console.log(`Área detectada por palabra clave "${keyword}": ${areaData.name} (Nivel ${areaData.level})`);
        return areaKey;
      }
    }
  }
  
  console.log(`No se encontró área por palabras clave`);
  return null;
}

function detectAreaFromAddress(address) {
  if (!address) return 'default';
  
  console.log(`Analizando dirección para detección de área: "${address}"`);
  
  // Primero intentar detección por código postal (más confiable)
  const zipCode = extractZipCodeFromAddress(address);
  if (zipCode) {
    const areaByZip = detectAreaByZipCode(zipCode);
    if (areaByZip) {
      return areaByZip;
    }
  }
  
  // Luego intentar detección por palabras clave
  const areaByKeyword = detectAreaByKeywords(address);
  if (areaByKeyword) {
    return areaByKeyword;
  }
  
  console.log(`No se detectó área específica, usando precios estándar`);
  return 'default';
}

function getAreaBasedPricing(pickup, dropoff, totalMiles = null) {
  const bookingType = document.getElementById("booking-type").value;
  
  // Para Point-to-Point, usar precios por distancia
  if (bookingType === "point-to-point") {
    if (totalMiles === null) {
      console.log("Point-to-Point detectado pero sin distancia - usando precios estándar temporalmente");
      return {
        area: 'point-to-point-pending',
        baseFare: PR.BF,
        suvBaseFare: PR.SUV_BF,
        areaName: 'Point-to-Point (pending distance calculation)',
        level: 0
      };
    }
    
    console.log("=== PRECIOS POINT-TO-POINT POR DISTANCIA ===");
    const sedanBaseFare = POINT_TO_POINT_DISTANCE_PRICING.getBaseFareByDistance(totalMiles, false);
    const suvBaseFare = POINT_TO_POINT_DISTANCE_PRICING.getBaseFareByDistance(totalMiles, true);
    
    return {
      area: 'point-to-point-distance',
      baseFare: sedanBaseFare,
      suvBaseFare: suvBaseFare,
      areaName: `Point-to-Point (${totalMiles.toFixed(1)} miles)`,
      level: 0,
      distanceMiles: totalMiles
    };
  }
  
  // Solo aplicar precios por área para Airport Transfer
  if (bookingType !== "transfer") {
    console.log("No es Airport Transfer, usando precios estándar");
    return {
      area: 'default',
      baseFare: PR.BF,
      suvBaseFare: PR.SUV_BF,
      areaName: 'Standard',
      level: 0
    };
  }
  
  // Resto del código existente para Airport Transfer...
  console.log("=== DETECCIÓN DE PRECIOS POR ÁREA ===");
  console.log(`Pickup: ${pickup}`);
  console.log(`Dropoff: ${dropoff}`);
  
  const pickupArea = detectAreaFromAddress(pickup);
  const dropoffArea = detectAreaFromAddress(dropoff);
  
  console.log(`Área pickup: ${pickupArea}`);
  console.log(`Área dropoff: ${dropoffArea}`);
  
  let selectedArea = 'default';
  
  if (isBNAAirport(pickup)) {
    selectedArea = dropoffArea;
    console.log(`Pickup en aeropuerto detectado, usando área de dropoff: ${selectedArea}`);
  } else if (isBNAAirport(dropoff)) {
    selectedArea = pickupArea;
    console.log(`Dropoff en aeropuerto detectado, usando área de pickup: ${selectedArea}`);
  } else {
    selectedArea = pickupArea;
    console.log(`Ningún aeropuerto detectado, usando área de pickup: ${selectedArea}`);
  }
  
  const areaConfig = AREA_PRICING_CONFIG[selectedArea] || AREA_PRICING_CONFIG.default;
  
  console.log(`Área seleccionada: ${selectedArea} (${areaConfig.name}) - Nivel ${areaConfig.level || 0}`);
  console.log(`Precio base: $${areaConfig.baseFare.toFixed(2)}`);
  console.log(`Precio base SUV: $${areaConfig.suvBaseFare.toFixed(2)}`);
  console.log("==========================================");
  
  return {
    area: selectedArea,
    baseFare: areaConfig.baseFare,
    suvBaseFare: areaConfig.suvBaseFare,
    areaName: areaConfig.name,
    level: areaConfig.level || 0
  };
}

let debounceTimer;
let isGoogleMapsReady = false;
let mapInitialized = false;
function debounceMapUpdate(func, wait) {clearTimeout(debounceTimer);debounceTimer = setTimeout(func, wait);}
function isBNAAirport(a){if(!a)return!1;a=a.toLowerCase();return a.includes("bna")||a.includes("nashville int")||a.includes("nashville airport")}
function sRP(){document.getElementById('sm').style.display='block';document.getElementById('redir').style.display='flex';}
function gSP(){try{sessionStorage.removeItem('paymentInitiated');sessionStorage.removeItem('paymentStartTime');localStorage.removeItem('paymentData');}catch(e){console.error("Processing error:",e);}}
function cFSR(){return!1}
function sL(){document.getElementById("lo").style.display="flex"}
function hL(){document.getElementById("lo").style.display="none"}
function togglePriceDetails() {
  const detailsContainer = document.getElementById('price-breakdown-details');
  const toggle = document.querySelector('.more-details-toggle');
  
  if (detailsContainer.classList.contains('collapsed')) {
    detailsContainer.classList.remove('collapsed');
    detailsContainer.classList.add('expanded');
    toggle.classList.add('expanded');
  } else {
    detailsContainer.classList.remove('expanded');
    detailsContainer.classList.add('collapsed');
    toggle.classList.remove('expanded');
  }
}
function dMU(){const priceContainer=document.getElementById("price-breakdown");const bookingType=document.getElementById("booking-type").value;if(bookingType!=="hourly"){if(priceContainer&&!document.getElementById("price-loading")){const loadingDiv=document.createElement("div");loadingDiv.id="price-loading";loadingDiv.className="price-loading";loadingDiv.innerHTML='<i class="fas fa-spinner"></i> Calculating price...';priceContainer.innerHTML='';priceContainer.appendChild(loadingDiv);}}if(mUTm)clearTimeout(mUTm);const loadingEl=document.getElementById("map-loading");if(loadingEl)loadingEl.style.opacity="1";const selectedDate=document.getElementById("pickup-date").value;const selectedTime=document.getElementById("pickup-time").value;window.selectedDepartureTime=null;if(selectedDate&&selectedTime){const departureTime=new Date(`${selectedDate}T${selectedTime}`);if(!isNaN(departureTime.getTime())){window.selectedDepartureTime=departureTime;}}debounceMapUpdate(async function(){console.log("dMU timer triggered, calling uM");await uM();},800);}
function tTT() {var e = document.getElementById("trip-type").value, t = document.getElementById("dropoff-container");"round-trip" === e ? (t.style.display = "none", document.getElementById("dropoff").value = document.getElementById("pickup").value) : t.style.display = "block";dMU();}
window.addEventListener("DOMContentLoaded", () => {
  console.log("DOM loaded at", new Date().toISOString());
  
  // Detectar si estamos en un dispositivo móvil
  const isMobile = window.innerWidth < 768;
  console.log("Device type detected:", isMobile ? "mobile" : "desktop", "width:", window.innerWidth);
  
  // Función para configurar elementos básicos del DOM
  function setupBasicElements() {
    // Configurar la fecha mínima para el selector de fecha
    document.getElementById("pickup-date").min = (new Date).toISOString().split("T")[0];
    
    // Mostrar el selector de tipo de booking
    document.querySelector(".booking-type-selector").style.display = "flex";
    
    // Configuración de horas para tarifas por hora
    document.getElementById("trip-hours").value = 3;
    document.getElementById("hours-display").textContent = 3;
  }
  
  // Función para manejar la inicialización de Google Maps
  function setupGoogleMapsInitialization(isMobile) {
    console.log("Setting up Google Maps initialization for", isMobile ? "mobile" : "desktop");
    let mapsInitAttempts = 0;
    const maxAttempts = isMobile ? 10 : 8;
    const retryDelay = isMobile ? 1000 : 800;
    
    function initializeMapsWithRetry() {
      mapsInitAttempts++;
      console.log(`Attempting to initialize Google Maps (attempt ${mapsInitAttempts})`);
      
      if (typeof google !== 'undefined' && typeof google.maps !== 'undefined' && typeof google.maps.places !== 'undefined') {
        console.log("Google Maps API is available, initializing autocomplete");
        isGoogleMapsReady = true;
        
        try {
          // Esperar un poco más en móviles antes de inicializar autocomplete
          setTimeout(() => {
            initAC();
            console.log("Autocomplete initialized successfully");
          }, isMobile ? 300 : 100);
        } catch (e) {
          console.error("Error initializing autocomplete:", e);
          // Retry en caso de error
          if (mapsInitAttempts < maxAttempts) {
            setTimeout(initializeMapsWithRetry, retryDelay);
          }
        }
      } else {
        console.log("Google Maps not yet available");
        
        if (mapsInitAttempts < maxAttempts) {
          setTimeout(initializeMapsWithRetry, retryDelay);
        } else {
          console.warn("Failed to initialize Google Maps after multiple attempts");
          
          // Último intento: recargar el script
          if (mapsInitAttempts === maxAttempts) {
            console.log("Attempting to reload Google Maps script");
            const script = document.createElement('script');
            script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyBECPPi3uRa4A5CQ7-zIvQ3ooJu3g9EQKg&libraries=places&callback=initMapCallback";
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
            
            setTimeout(initializeMapsWithRetry, 2000);
          }
        }
      }
    }
    
    // Comenzar el proceso con retardo inicial apropiado
    setTimeout(initializeMapsWithRetry, isMobile ? 800 : 400);
  }
  
  // Función para configurar event listeners
  function setupEventListeners() {
    // Configuración del tipo de viaje
    if (document.getElementById("trip-type")) {
      document.getElementById("trip-type").addEventListener("change", tTT);
      tTT();
    }
    
    // Función auxiliar para añadir listeners
    function addChangeListener(id, callback) {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener("change", callback);
        console.log(`Added change listener to ${id}`);
      } else {
        console.warn(`Element ${id} not found for change listener`);
      }
    }
    
    // Añadir listeners con mejor manejo de errores
    try {
      addChangeListener("pickup-date", dMU);
      addChangeListener("pickup-time", dMU);
      addChangeListener("pickup", function() { 
        dMU(); 
        autoSwitchToAirportTransfer(); 
      });
      addChangeListener("dropoff", function() { 
        dMU(); 
        autoSwitchToAirportTransfer(); 
      });
      addChangeListener("location-type", function() { tAF() });
      addChangeListener("passengers", dMU);
      addChangeListener("kids", dMU);
      addChangeListener("luggage", dMU);
      
      // Listeners de input con debounce para mejor rendimiento
      const pickupInput = document.getElementById("pickup");
      const dropoffInput = document.getElementById("dropoff");
      
      if (pickupInput) {
        pickupInput.addEventListener("input", function() { 
          console.log("Pickup input changed, debouncing map update");
          const debounceDelay = isMobile ? 2000 : 1200;
          debounceMapUpdate(dMU, debounceDelay); 
        });
      }
      
      if (dropoffInput) {
        dropoffInput.addEventListener("input", function() { 
          console.log("Dropoff input changed, debouncing map update");
          const debounceDelay = isMobile ? 2000 : 1200;
          debounceMapUpdate(dMU, debounceDelay); 
        });
      }
    } catch (e) {
      console.error("Error setting up event listeners:", e);
    }
    
    // Configuración de listeners para los botones de tipo de reserva
    try {
      document.getElementById("hourly-btn").addEventListener("click", function() {
        console.log("Switching to hourly mode");
        document.getElementById("luggage-container").style.display = "none";
      });
      
      document.getElementById("transfer-btn").addEventListener("click", function() {
        console.log("Switching to transfer mode");
        document.getElementById("luggage-container").style.display = "block";
      });
      
      document.getElementById("point-btn").addEventListener("click", function() {
        console.log("Switching to point-to-point mode");
        document.getElementById("luggage-container").style.display = "block";
      });
    } catch (e) {
      console.error("Error setting up booking type buttons:", e);
    }
  }
  
  // Función para limpiar datos de sesiones
  function clearSessionData() {
    try {
      localStorage.removeItem('paymentCompleted');
      localStorage.removeItem('paymentInProgress');
      localStorage.removeItem('finalRedirect');
      localStorage.removeItem('squareRedirectTime');
      sessionStorage.removeItem('paymentInitiated');
      sessionStorage.removeItem('paymentStartTime');
      sessionStorage.removeItem('paymentCompleted');
      sessionStorage.removeItem('pageViewedAfterPayment');
      document.cookie = "payment_complete=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;";
      document.cookie = "payment_started=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;";
      document.cookie = "target_redirect=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;";
    } catch (e) {
      console.warn("Error clearing session data:", e);
    }
  }
  
  // Función para configuración inicial del tipo de booking
  function setupInitialBookingType() {
    // Inicializar el tipo de booking
    const initialBookingType = document.getElementById("booking-type").value;
    console.log("Initial booking type:", initialBookingType);
    
    if (initialBookingType === "transfer") {
      sBT("transfer");
    } else {
      sBT("hourly");
    }
    
    // Configuración de visualización según el tipo de reserva
    if (document.getElementById("booking-type").value === "hourly") {
      document.getElementById("luggage-container").style.display = "none";
    }
    
    // Si está en modo hourly, inicializar el precio fijo y mostrar la sección de vehículo
    if (document.getElementById("booking-type").value === "hourly") {
      setTimeout(function() {
        console.log("Setting up hourly pricing");
        
        // Actualizar el precio fijo
        try {
          updateFixedHourlyPrice();
          console.log("Fixed hourly price updated");
        } catch (e) {
          console.error("Error updating fixed hourly price:", e);
        }
        
        // Asegurarse de que el componente de precio fijo sea visible
        const fixedPriceBox = document.getElementById("fixed-hourly-price");
        if (fixedPriceBox) {
          fixedPriceBox.style.display = "block";
        }
        
        // Mostrar la sección de vehículos automáticamente
        const vehicleSection = document.getElementById("vehicle-section");
        if (vehicleSection) {
          vehicleSection.classList.remove("hidden");
          console.log("Vehicle section displayed");
        }
        
        try {
          lVBPC();
        } catch (e) {
          console.error("Error in lVBPC:", e);
        }
        
        // También calcular precio para el sistema interno
        try {
          const hours = parseInt(document.getElementById("trip-hours").value) || 3;
          const hourlyRate = PR.HR;
          const total = hours * hourlyRate;
          
          // Crear objeto de detalles de precio
          const priceDetails = {
            baseFare: hours * hourlyRate,
            total: total,
            details: {
              hours: hours,
              hourlyRate: hourlyRate
            }
          };
          
          // Guardar los detalles del precio
          lPDet = priceDetails;
          console.log("Hourly price details set:", priceDetails);
          
          // Configurar el precio en el botón de pago
          const checkoutButton = document.getElementById("checkout-button");
          if (checkoutButton) {
            checkoutButton.setAttribute("data-price", total.toFixed(2));
            console.log("Checkout button price set to", total.toFixed(2));
          }
        } catch (e) {
          console.error("Error setting up price details:", e);
        }
      }, isMobile ? 1000 : 600);
    }
  }
  
  // EJECUTAR TODAS LAS FUNCIONES EN EL ORDEN CORRECTO
  
  // Inicializar elementos básicos inmediatamente
  setupBasicElements();
  
  // Inicializar el mapa con retardo apropiado para el dispositivo
  setTimeout(() => {
    console.log("Initializing map display");
    initMapDisplay();
  }, isMobile ? 500 : 200);
  
  // Setup Google Maps con mejor manejo para móviles
  setupGoogleMapsInitialization(isMobile);
  
  // Setup event listeners
  setupEventListeners();
  
  // Limpiar datos de sesiones
  clearSessionData();
  
  // Setup inicial para booking type
  setupInitialBookingType();
});
  function addChangeListener(id, callback) {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener("change", callback);
      console.log(`Added change listener to ${id}`);
    } else {
      console.warn(`Element ${id} not found for change listener`);
    }
  }
  
  // Añadir listners con mejor manejo de errores
  try {
    addChangeListener("pickup-date", dMU);
    addChangeListener("pickup-time", dMU);
    addChangeListener("pickup", dMU);
    addChangeListener("dropoff", dMU);
    addChangeListener("location-type", function() { tAF() });
    addChangeListener("pickup", autoSwitchToAirportTransfer);
    addChangeListener("dropoff", autoSwitchToAirportTransfer);
    addChangeListener("passengers", dMU);
    addChangeListener("kids", dMU);
    addChangeListener("luggage", dMU);
    
    // Listeners de input con debounce para mejor rendimiento
    const pickupInput = document.getElementById("pickup");
    const dropoffInput = document.getElementById("dropoff");
    
    if (pickupInput) {
      pickupInput.addEventListener("input", function() { 
        console.log("Pickup input changed, debouncing map update");
        debounceMapUpdate(dMU, isMobile ? 1500 : 1000); 
      });
    }
    
    if (dropoffInput) {
      dropoffInput.addEventListener("input", function() { 
        console.log("Dropoff input changed, debouncing map update");
        debounceMapUpdate(dMU, isMobile ? 1500 : 1000); 
      });
    }
  } catch (e) {
    console.error("Error setting up event listeners:", e);
  }
  
  // Configuración de horas para tarifas por hora
  document.getElementById("trip-hours").value = 3;
  document.getElementById("hours-display").textContent = 3;
  
  // Limpiar datos de sesiones anteriores
  try {
    localStorage.removeItem('paymentCompleted');
    localStorage.removeItem('paymentInProgress');
    localStorage.removeItem('finalRedirect');
    localStorage.removeItem('squareRedirectTime');
    sessionStorage.removeItem('paymentInitiated');
    sessionStorage.removeItem('paymentStartTime');
    sessionStorage.removeItem('paymentCompleted');
    sessionStorage.removeItem('pageViewedAfterPayment');
    document.cookie = "payment_complete=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;";
    document.cookie = "payment_started=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;";
    document.cookie = "target_redirect=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;";
  } catch (e) {
    console.warn("Error clearing session data:", e);
  }
  
  // Configuración de visualización según el tipo de reserva
  if (document.getElementById("booking-type").value === "hourly") {
    document.getElementById("luggage-container").style.display = "none";
  }
  
  // Configurar listeners para los botones de tipo de reserva
  try {
    document.getElementById("hourly-btn").addEventListener("click", function() {
      console.log("Switching to hourly mode");
      document.getElementById("luggage-container").style.display = "none";
    });
    
    document.getElementById("transfer-btn").addEventListener("click", function() {
      console.log("Switching to transfer mode");
      document.getElementById("luggage-container").style.display = "block";
    });
    
    document.getElementById("point-btn").addEventListener("click", function() {
      console.log("Switching to point-to-point mode");
      document.getElementById("luggage-container").style.display = "block";
    });
  } catch (e) {
    console.error("Error setting up booking type buttons:", e);
  }
  
  // Iniciar el autocompletado cuando Google Maps esté listo
  console.log("Setting up Google Maps initialization");
  let mapsInitAttempts = 0;
  
  function initializeMapsWithRetry() {
    mapsInitAttempts++;
    console.log(`Attempting to initialize Google Maps (attempt ${mapsInitAttempts})`);
    
    if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
      console.log("Google Maps API is available, initializing autocomplete");
      try {
        initAC();
        console.log("Autocomplete initialized successfully");
      } catch (e) {
        console.error("Error initializing autocomplete:", e);
      }
    } else {
      console.log("Google Maps not yet available");
      
      // Reintentar con límite de intentos
      if (mapsInitAttempts < 8) {
        setTimeout(initializeMapsWithRetry, 800);
      } else {
        console.warn("Failed to initialize Google Maps after multiple attempts");
        
        // Intentar recargar el script como último recurso
        if (mapsInitAttempts === 8) {
          console.log("Attempting to reload Google Maps script");
          const script = document.createElement('script');
          script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyBECPPi3uRa4A5CQ7-zIvQ3ooJu3g9EQKg&libraries=places&callback=initMapCallback";
          script.async = true;
          script.defer = true;
          document.head.appendChild(script);
          
          setTimeout(initializeMapsWithRetry, 1500);
        }
      }
    }
  }
  
  // Comenzar el proceso de inicialización con un pequeño retardo inicial
  setTimeout(initializeMapsWithRetry, isMobile ? 600 : 300);
  
  // Si está en modo hourly, inicializar el precio fijo y mostrar la sección de vehículo
  if (document.getElementById("booking-type").value === "hourly") {
    setTimeout(function() {
      console.log("Setting up hourly pricing");
      
      // Actualizar el precio fijo
      try {
        updateFixedHourlyPrice();
        console.log("Fixed hourly price updated");
      } catch (e) {
        console.error("Error updating fixed hourly price:", e);
      }
      
      // Asegurarse de que el componente de precio fijo sea visible
      const fixedPriceBox = document.getElementById("fixed-hourly-price");
      if (fixedPriceBox) {
        fixedPriceBox.style.display = "block";
      }
      
      // Mostrar la sección de vehículos automáticamente
      const vehicleSection = document.getElementById("vehicle-section");
      if (vehicleSection) {
        vehicleSection.classList.remove("hidden");
        console.log("Vehicle section displayed");
      }
      
      try {
        lVBPC();
      } catch (e) {
        console.error("Error in lVBPC:", e);
      }
      
      // También calcular precio para el sistema interno
      try {
        const hours = parseInt(document.getElementById("trip-hours").value) || 3;
        const hourlyRate = PR.HR;
        const total = hours * hourlyRate;
        
        // Crear objeto de detalles de precio
        const priceDetails = {
          baseFare: hours * hourlyRate,
          total: total,
          details: {
            hours: hours,
            hourlyRate: hourlyRate
          }
        };
        
        // Guardar los detalles del precio
        lPDet = priceDetails;
        console.log("Hourly price details set:", priceDetails);
        
        // Configurar el precio en el botón de pago
        const checkoutButton = document.getElementById("checkout-button");
        if (checkoutButton) {
          checkoutButton.setAttribute("data-price", total.toFixed(2));
          console.log("Checkout button price set to", total.toFixed(2));
        }
      } catch (e) {
        console.error("Error setting up price details:", e);
      }
    }, isMobile ? 800 : 600);
  }

  // Para solucionar problemas específicos en móviles, vamos a forzar una actualización del mapa
  if (isMobile) {
    console.log("Adding mobile-specific map update");
    setTimeout(() => {
      try {
        console.log("Forcing map update for mobile device");
        uM();
      } catch (e) {
        console.error("Error in forced mobile map update:", e);
      }
    }, 1500);
  }
  
  // Registrar las dimensiones del contenedor del mapa para depuración
  setTimeout(() => {
    const mapContainer = document.getElementById("map-container");
    if (mapContainer) {
      const rect = mapContainer.getBoundingClientRect();
      console.log("Map container dimensions:", {
        width: rect.width,
        height: rect.height,
        visible: rect.width > 0 && rect.height > 0
      });
    }
  }, 1000);
function iACF(e) {
  if (!e) {
    console.warn("iACF called with null element");
    return;
  }
  
  // Detectar si estamos en un dispositivo móvil
  const isMobile = window.innerWidth < 768;
  console.log(`Setting up autocomplete for element ${e.id || 'unknown'} on ${isMobile ? 'mobile' : 'desktop'}`);
  
  try {
    // Configuración básica de atributos para mejorar la experiencia de usuario
    e.setAttribute("autocomplete", "off");
    e.setAttribute("autocorrect", "off");
    e.setAttribute("autocapitalize", "off");
    e.setAttribute("spellcheck", "false");
    
    // Añadir atributos específicos para móviles para mejorar el comportamiento del teclado
    if (isMobile) {
      e.setAttribute("inputmode", "text");
      e.setAttribute("enterkeyhint", "done");
    }
    
    // Verificar si Google Maps está disponible
    if (typeof google === 'undefined' || typeof google.maps === 'undefined' || typeof google.maps.places === 'undefined') {
      console.warn("Google Maps API not fully loaded yet, setting up fallback listeners");
      e.addEventListener('change', function() {
        console.log(`Input changed via fallback for ${e.id || 'unknown'}`);
        dMU();
        checkAirportAddressStatus();
        tAF();
      });
      
      // Intentar configurar de nuevo después de un tiempo si aún no está disponible
      setTimeout(function() {
        if (typeof google !== 'undefined' && typeof google.maps !== 'undefined' && typeof google.maps.places !== 'undefined') {
          console.log("Google Maps now available, retry autocomplete setup");
          setupAutocomplete();
        } else {
          console.error("Google Maps still not available after delay");
        }
      }, 2000);
      
      return;
    }
    
    function setupAutocomplete() {
      // Verificar si ya tiene autocomplete configurado
      if (e.hasAttribute("data-has-autocomplete")) {
        console.log(`Autocomplete already set up for ${e.id || 'unknown'}`);
        return;
      }
      
      // Asegurarse de que mTNB está definido
      if (!mTNB) {
        console.log("mTNB not defined, creating default bounds for Nashville area");
        mTNB = new google.maps.LatLngBounds(
          new google.maps.LatLng(35.5, -87.5),
          new google.maps.LatLng(36.5, -85.5)
        );
      }
      
      // Configurar opciones específicas para móviles
      const autocompleteOptions = {
        bounds: mTNB,
        strictBounds: true,
        componentRestrictions: {country: 'us'},
        fields: ['address_components', 'geometry', 'name', 'formatted_address', 'types']
      };
      
      // En móviles, limitar los resultados para mejor rendimiento
      //if (isMobile) {
      //  autocompleteOptions.types = ['address'];}
      
      console.log(`Creating autocomplete for ${e.id || 'unknown'} with options:`, autocompleteOptions);
      
      // Crear el objeto Autocomplete
      let autocomplete = new google.maps.places.Autocomplete(e, autocompleteOptions);
      
      // Manejar el evento place_changed
      autocomplete.addListener("place_changed", function() {
        console.log(`Place changed for ${e.id || 'unknown'}`);
        const place = autocomplete.getPlace();
        
        if (!place || !place.address_components) {
          console.warn("Invalid place selected or place without address components");
          dMU();
          checkAirportAddressStatus();
          tAF();
          return;
        }
        
        // Registro adicional para depuración
        console.log(`Selected place: ${place.formatted_address}`);
        
        // En dispositivos móviles, forzar blur para cerrar el teclado virtual
        if (isMobile) {
          e.blur();
        }
        
        // Actualizar estado y UI
        checkAirportAddressStatus();
        tAF();
        
        // Usar setTimeout para asegurar que el valor del campo se actualice primero
        setTimeout(function() {
          console.log("Updating map after place selection");
          dMU();
        }, 100);
      });
      
      // Agregar event listener para input para manejar cambios manuales
      e.addEventListener('input', function() {
        console.log(`Input change detected for ${e.id || 'unknown'}`);
        checkAirportAddressStatus();
        
        // No llamar a dMU directamente, usar debounce para mejorar rendimiento
        if (typeof debounceMapUpdate === 'function') {
          debounceMapUpdate(dMU, isMobile ? 1500 : 1000);
        } else {
          dMU();
        }
      });
      
      // Marcar que el elemento ya tiene autocomplete configurado
      e.setAttribute("data-has-autocomplete", "true");
      
      // En dispositivos móviles, agregar listener para el evento focus
      if (isMobile) {
        e.addEventListener('focus', function() {
          console.log(`Focus event on ${e.id || 'unknown'}`);
          
          // Scroll a este elemento después de un breve retraso
          setTimeout(function() {
            e.scrollIntoView({behavior: 'smooth', block: 'center'});
          }, 300);
        });
      }
    }
    
    // Configurar autocomplete
    setupAutocomplete();
    
  } catch (error) {
    console.error(`Error setting up autocomplete for ${e.id || 'unknown'}:`, error);
    console.error("Error details:", error.message);
    console.error("Stack trace:", error.stack);
    
    // Configurar listeners de fallback
    e.addEventListener('change', function() {
      console.log(`Change event (fallback) on ${e.id || 'unknown'}`);
      dMU();
      checkAirportAddressStatus();
      tAF();
    });
    
    e.addEventListener('blur', function() {
      console.log(`Blur event (fallback) on ${e.id || 'unknown'}`);
      setTimeout(dMU, 300);
    });
  }
}
function showDefaultMap(){const e=document.getElementById("map-frame");if(!e)return;document.getElementById("map-loading").style.opacity="1",e.src="https://www.google.com/maps/embed/v1/place?key=AIzaSyBECPPi3uRa4A5CQ7-zIvQ3ooJu3g9EQKg&q=Nashville,Tennessee&zoom=10",e.onload=()=>{document.getElementById("map-loading").style.opacity="0",e.style.opacity="1"},setTimeout(()=>{document.getElementById("map-loading").style.opacity="0",e.style.opacity="1"},3e3)}window.addEventListener("DOMContentLoaded", () => {initMapDisplay();document.getElementById("pickup-date").min = (new Date).toISOString().split("T")[0];document.querySelector(".booking-type-selector").style.display = "flex";"transfer" === document.getElementById("booking-type").value ? sBT("transfer") : sBT("hourly");document.getElementById("trip-type") && (document.getElementById("trip-type").addEventListener("change", tTT), tTT());document.getElementById("pickup").addEventListener("change", dMU);document.getElementById("dropoff").addEventListener("change", dMU);document.getElementById("location-type").addEventListener("change", function() { tAF() });document.getElementById("trip-hours").value = 3;document.getElementById("hours-display").textContent = 3;localStorage.removeItem('paymentCompleted');localStorage.removeItem('paymentInProgress');localStorage.removeItem('finalRedirect');localStorage.removeItem('squareRedirectTime');sessionStorage.removeItem('paymentInitiated');sessionStorage.removeItem('paymentStartTime');sessionStorage.removeItem('paymentCompleted');sessionStorage.removeItem('pageViewedAfterPayment');document.cookie = "payment_complete=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;";document.cookie = "payment_started=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;";document.cookie = "target_redirect=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;";if (document.getElementById("booking-type").value === "hourly") {document.getElementById("luggage-container").style.display = "none";}document.getElementById("hourly-btn").addEventListener("click", function() {document.getElementById("luggage-container").style.display = "none"});document.getElementById("transfer-btn").addEventListener("click", function() {document.getElementById("luggage-container").style.display = "block";});setTimeout(function() { typeof google === 'undefined' || typeof google.maps === 'undefined' && initAC() }, 500);});
// Find and update the hS function to properly handle hourly pricing
async function hS(e){
  if(e && e.preventDefault){
    e.preventDefault();
  }
  
  if(pIP){
    return void alert("Payment is already being processed. Please wait.");
  }
  
  const bookingType = document.getElementById("booking-type").value;
  
  // Validation for passenger limits in transfer and point-to-point
  if(bookingType === "transfer" || bookingType === "point-to-point"){
    const passengersCount = parseInt(document.getElementById("passengers").value) || 0;
    const kidsCount = parseInt(document.getElementById("kids").value) || 0;
    const totalPassengers = passengersCount + kidsCount;
    
    if(totalPassengers > 4){
      alert("Para " + (bookingType === "transfer" ? "Airport Transfer" : "Point-to-Point") + ", no hay vehículos disponibles para más de 4 pasajeros. Por favor reduzca el número de pasajeros.");
      return;
    }
  }
  
  // Validation for airport transfers
  if(bookingType === "transfer"){
    const pickup = document.getElementById("pickup").value;
    const dropoff = document.getElementById("dropoff").value;
    
    if(!isBNAAirport(pickup) && !isBNAAirport(dropoff)){
      alert("For airport transfers, at least one address must be Nashville International Airport (BNA).");
      return;
    }
    
    // Check flight information for airport pickups
    if(isBNAAirport(pickup)){
      const airline = document.getElementById("airline").value.trim();
      const flight = document.getElementById("flight").value.trim();
      
      if(!airline || !flight){
        alert("Please provide your arrival flight information.");
        return;
      }
    }
    
    // Check flight information for airport dropoffs
    if(isBNAAirport(dropoff)){
      const depAirline = document.getElementById("dep-airline").value.trim();
      const depFlight = document.getElementById("dep-flight").value.trim();
      
      if(!depAirline || !depFlight){
        alert("Please provide your departure flight information.");
        return;
      }
    }
  } else if(bookingType === "point-to-point"){
    const pickup = document.getElementById("pickup").value;
    const dropoff = document.getElementById("dropoff").value;
    
    if(!pickup || !dropoff){
      alert("Please provide both pickup and dropoff points for Point-to-Point.");
      return;
    }
  }
  
  pIP = true;
  sL();
  
  try {
    // Collect booking data
    const bookingData = {
      bookingType: document.getElementById("booking-type").value,
      bookingDate: document.getElementById("pickup-date").value,
      bookingTime: document.getElementById("pickup-time").value,
      passengers: {
        adults: document.getElementById("passengers").value,
        kids: document.getElementById("kids").value,
        total: parseInt(document.getElementById("passengers").value) + parseInt(document.getElementById("kids").value),
        luggage: document.getElementById("luggage").value
      },
      contact: {
      phone: document.getElementById("phone").value,
      email: document.getElementById("email").value,
      firstName: document.getElementById("first-name").value,
      lastName: document.getElementById("last-name").value
    }
    };
    
    // Handle hourly bookings
    if("hourly" === bookingData.bookingType){
      bookingData.hourly = {
        hours: document.getElementById("trip-hours").value
      };
      bookingData.pickup = document.getElementById("pickup").value;
      bookingData.dropoff = "";
      bookingData.itinerary = document.getElementById("hourly-itinerary").value;
    } else {
      // Handle transfer or point-to-point bookings
      bookingData.transfer = {
        pickup: document.getElementById("pickup").value,
        dropoff: document.getElementById("dropoff").value
      };
      
      if(bookingData.bookingType === "transfer"){
        if(isBNAAirport(bookingData.transfer.pickup)){
          bookingData.flightInfo = {
            type: "arrival",
            airline: document.getElementById("airline").value,
            flightNumber: document.getElementById("flight").value,
            flightTime: document.getElementById("arrival-time").value
          };
        }
        
        if(isBNAAirport(bookingData.transfer.dropoff)){
          bookingData.departureInfo = {
            type: "departure",
            airline: document.getElementById("dep-airline").value,
            flightNumber: document.getElementById("dep-flight").value,
            flightTime: document.getElementById("departure-time").value
          };
        }
      }
      
      bookingData.specialRequest = document.getElementById("transfer-special-request").value;
      bookingData.stops = [];
    }
    
    // Get price from the checkout button attribute
    let price = document.getElementById("checkout-button").getAttribute("data-price");
    
    // For hourly bookings, calculate price if it's not set
    if (bookingData.bookingType === "hourly" && (!price || price === "0.00")) {
      const hours = parseInt(document.getElementById("trip-hours").value) || 3;
      const hourlyRate = PR.HR; // 95.00
      price = (hours * hourlyRate).toFixed(2);
      // Make sure to update the button attribute
      document.getElementById("checkout-button").setAttribute("data-price", price);
    }
    
    bookingData.price = price;
    bookingData.priceDetails = lPDet;
    
    // Get selected vehicle
    const selectedVehicle = document.querySelector('.vehicle.selected');
    if(selectedVehicle){
      bookingData.vehicle = {
        type: selectedVehicle.querySelector('span').textContent,
        id: selectedVehicle.id
      };
    }
    
    // Format booking details
    const bookingDetails = fBD(bookingData);
    document.getElementById("booking-details").value = bookingDetails;
    
    // Store booking data in localStorage
    localStorage.setItem("bookingData", JSON.stringify(bookingData));
    
    // Send data to Formspree
    try {
      const form = document.getElementById("booking-form");
      const response = await fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: {
          Accept: 'application/json'
        }
      });
      
      if(response.ok){
        console.log("Formspree success:", await response.json());
      } else {
        console.error("Formspree error:", await response.text());
      }
    } catch(error){
      console.error("Formspree submission error:", error);
    }
    
    // Show success message
    document.getElementById('sm').style.display = 'block';
    
    // Prepare data for Square payment
    const paymentData = {
      price: parseFloat(bookingData.price),
      email: bookingData.contact.email,
      description: `${bookingData.bookingType === "transfer" ? "AIRPORT TRANSFER" : bookingData.bookingType === "point-to-point" ? "POINT-TO-POINT" : "HOURLY"} Booking for ${bookingData.bookingDate} ${bookingData.bookingTime}`,
      fullBookingData: bookingData
    };
    
    // Send request to Square API
    const paymentResponse = await fetch("https://square-server.vercel.app/create-checkout-session", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Accept: 'application/json'
      },
      body: JSON.stringify(paymentData)
    });
    
    if(!paymentResponse.ok){
      let errorText;
      try {
        errorText = await paymentResponse.text();
      } catch(e) {
        errorText = `HTTP ${paymentResponse.status} - ${paymentResponse.statusText}`;
      }
      console.error("Square API Error:", errorText);
      throw new Error(`Square checkout failed: ${errorText}`);
    }
    
    const paymentResult = await paymentResponse.json();
    
    if(!paymentResult.url){
      throw new Error("No checkout URL received from Square");
    }
    
    // Redirect to Square checkout
    window.location.href = paymentResult.url;
  } catch(error){
    console.error("Error during checkout process:", error);
    alert(`Error processing payment: ${error.message}`);
    hL();
    pIP = false;
  }
}

// Update the updateFixedHourlyPrice function to ensure the checkout button price is properly set
function updateFixedHourlyPrice() {
  const hours = parseInt(document.getElementById("trip-hours").value) || 3;
  
  // Obtener el vehículo seleccionado
  const selectedVehicle = document.querySelector('.vehicle.selected');
  const isVehicleSelected = selectedVehicle !== null;
  const isSUV = isVehicleSelected && selectedVehicle.id === 'cadillac';
  
  // If no vehicle is selected, use SUV rates (higher price) as default
  const hourlyRate = isVehicleSelected ? (isSUV ? PR.SUV_HR : PR.HR) : PR.SUV_HR;
  
  const total = hours * hourlyRate;
  
  document.getElementById("fixed-hours-display").textContent = hours;
  document.getElementById("fixed-rate").textContent = hourlyRate.toFixed(2);
  document.getElementById("fixed-price").textContent = (hours * hourlyRate).toFixed(2);
  document.getElementById("fixed-total").textContent = total.toFixed(2);
  
  if (document.getElementById("checkout-button")) {
    document.getElementById("checkout-button").setAttribute("data-price", total.toFixed(2));
  }
  
  lPDet = {
    baseFare: hours * hourlyRate,
    total: total,
    details: {
      hours: hours,
      hourlyRate: hourlyRate
    }
  };
  
  console.log("Updated hourly price:", total.toFixed(2));
}

function sPCC(){return false;}
function initAC(){if(typeof google==='undefined'||typeof google.maps==='undefined'){setTimeout(initAC,2e3);return;}try{mTNB=new google.maps.LatLngBounds(new google.maps.LatLng(35.5,-87.5),new google.maps.LatLng(36.5,-85.5));iACF(document.getElementById('pickup'));iACF(document.getElementById('dropoff'));aPL();setupACL();}catch(e){[document.getElementById('pickup'),document.getElementById('dropoff')].forEach(e=>{e&&e.addEventListener('change',dMU);});}}
function cAT(e){return['airport','bna','flight','terminal'].some(t=>e.includes(t))}
function adjustDuration(e) {
  const hourInput = document.getElementById("trip-hours");
  const hoursDisplay = document.getElementById("hours-display");
  let hours = parseInt(hourInput.value) || 3;
  
  hours = Math.max(3, hours + e);
  hourInput.value = hours;
  hoursDisplay.textContent = hours;
  
  const activeButtonId = e < 0 ? "decrease-btn" : "increase-btn";
  document.getElementById("decrease-btn").classList.remove("active");
  document.getElementById("increase-btn").classList.remove("active");
  document.getElementById(activeButtonId).classList.add("active");
  
  setTimeout(() => {
    document.getElementById(activeButtonId).classList.remove("active");
  }, 300);
  
  // Obtener el vehículo seleccionado para usar la tarifa correcta
  const selectedVehicle = document.querySelector('.vehicle.selected');
  const isVehicleSelected = selectedVehicle !== null;
  const isSUV = isVehicleSelected && selectedVehicle.id === 'cadillac';
  
  // If no vehicle is selected, use SUV rates (higher price) as default
  const hourlyRate = isVehicleSelected ? (isSUV ? PR.SUV_HR : PR.HR) : PR.SUV_HR;
  
  const total = hours * hourlyRate;
  
  // Actualizar el precio fijo
  document.getElementById("fixed-hours-display").textContent = hours;
  document.getElementById("fixed-rate").textContent = hourlyRate.toFixed(2);
  document.getElementById("fixed-price").textContent = (hours * hourlyRate).toFixed(2);
  document.getElementById("fixed-total").textContent = total.toFixed(2);
  
  // Crear los detalles del precio para el sistema interno
  const priceDetails = {
    baseFare: hours * hourlyRate,
    total: total,
    details: {
      hours: hours,
      hourlyRate: hourlyRate
    }
  };
  
  // Guardar los detalles del precio
  lPDet = priceDetails;
  
  // Configurar el precio en el botón de pago
  document.getElementById("checkout-button").setAttribute("data-price", total.toFixed(2));
  
  // Asegurar que el botón esté visible
  if (document.querySelector(".vehicle.selected")) {
    document.getElementById("checkout-button").classList.remove("hidden");
  }
}
function cAHAT(){return cAT(document.getElementById("pickup").value.toLowerCase()) || cAT(document.getElementById("dropoff").value.toLowerCase());}
function setupACL(){const inputs = [document.getElementById("pickup"), document.getElementById("dropoff")];inputs.forEach(input => {if(input) {input.addEventListener('change', function() {cAAFAT();checkAirportAddressStatus();});}});}
function cAAFAT(){const e = document.getElementById("pickup").value.toLowerCase();const t = document.getElementById("dropoff").value.toLowerCase();const o = cAT(e) || cAT(t);const bookingType = document.getElementById("booking-type").value;if (bookingType !== "transfer") {return false;}if (!o && "airport" === document.getElementById("location-type").value) {document.getElementById("location-type").value = "all";tAF();} else if (o && "airport" !== document.getElementById("location-type").value) {document.getElementById("location-type").value = "airport";tAF();}return o;}
function checkAirportAddressStatus(){const pickup=document.getElementById("pickup").value;const dropoff=document.getElementById("dropoff").value;const hasAirport=isBNAAirport(pickup)||isBNAAirport(dropoff);const isHourly=document.getElementById("booking-type").value==="hourly";const isTransfer=document.getElementById("booking-type").value==="transfer";const isPointToPoint=document.getElementById("booking-type").value==="point-to-point";if(isHourly||isPointToPoint){document.getElementById("airport-pickup-indicator").style.display="none";document.getElementById("airport-dropoff-indicator").style.display="none";document.getElementById("pickup").style.borderColor="";document.getElementById("dropoff").style.borderColor="";document.getElementById("arrival-fields").style.display="none";document.getElementById("departure-fields").style.display="none";return true;}document.getElementById("airport-pickup-indicator").style.display="inline";document.getElementById("airport-dropoff-indicator").style.display="inline";document.getElementById("pickup").style.borderColor=hasAirport?"":"#a10000";document.getElementById("dropoff").style.borderColor=hasAirport?"":"#a10000";document.getElementById("airport-pickup-indicator").style.color=hasAirport?"#4CAF50":"#a10000";document.getElementById("airport-dropoff-indicator").style.color=hasAirport?"#4CAF50":"#a10000";document.getElementById("airport-pickup-indicator").innerHTML=isBNAAirport(pickup)?'<i class="fas fa-check-circle"></i> Airport detected':(isTransfer?'<i class="fas fa-exclamation-circle"></i> Airport required for pickup or dropoff':'');document.getElementById("airport-dropoff-indicator").innerHTML=isBNAAirport(dropoff)?'<i class="fas fa-check-circle"></i> Airport detected':(isTransfer?'<i class="fas fa-exclamation-circle"></i> Airport required for pickup or dropoff':'');document.getElementById("arrival-fields").style.display=isBNAAirport(pickup)?"block":"none";document.getElementById("departure-fields").style.display=isBNAAirport(dropoff)?"block":"none";return hasAirport;}
function autoSwitchToAirportTransfer() {const bookingType = document.getElementById("booking-type").value;if (bookingType === "hourly") {return;}const pickup = document.getElementById("pickup").value.toLowerCase();const dropoff = document.getElementById("dropoff").value.toLowerCase();const isPickupAirport = isBNAAirport(pickup);const isDropoffAirport = isBNAAirport(dropoff);if ((isPickupAirport || isDropoffAirport) && bookingType === "point-to-point") {alert("Se ha detectado una dirección de aeropuerto. Cambiando automáticamente a Airport Transfer.");sBT('transfer');checkAirportAddressStatus();}}
function isAA(e){return e&&(e.formatted_address?.toLowerCase().includes('airport')||e.name?.toLowerCase().includes('airport'))}
// Modificación de la función sBT para mostrar precio fijo para Hourly
function sBT(e) {
  const currentDate = document.getElementById("pickup-date").value;
  const currentTime = document.getElementById("pickup-time").value;
  const currentPhone = document.getElementById("phone").value;
  const currentEmail = document.getElementById("email").value;
  const currentFirstName = document.getElementById("first-name").value;
  const currentLastName = document.getElementById("last-name").value;
  const currentPickup = document.getElementById("pickup").value;
  const wasHourly = document.getElementById("booking-type").value === "hourly";
  const becomesHourly = e === "hourly";
  
  document.getElementById("booking-type").value = e;
  document.body.setAttribute("data-booking-type", e);
  document.getElementById("price-breakdown").innerHTML = "";
  lPDet = {};
  
  document.querySelector(".booking-type-selector").style.display = "flex";
  document.getElementById("transfer-btn").classList.toggle("active", "transfer" === e);
  document.getElementById("point-btn").classList.toggle("active", "point-to-point" === e);
  document.getElementById("hourly-btn").classList.toggle("active", "hourly" === e);
  
  const isHourly = "hourly" === e;
  const isPointToPoint = "point-to-point" === e;
  const isTransfer = "transfer" === e;
  
  // Mostrar u ocultar el precio fijo
  const fixedPriceBox = document.getElementById("fixed-hourly-price");
  if (fixedPriceBox) {
    fixedPriceBox.style.display = isHourly ? "block" : "none";
  }
  
  if (isTransfer) {
    let airportRequirementBox = document.getElementById("airport-requirement-box");
    if (!airportRequirementBox) {
      airportRequirementBox = document.createElement("div");
      airportRequirementBox.id = "airport-requirement-box";
      airportRequirementBox.className = "airport-requirement active";
      airportRequirementBox.innerHTML = `<i class="fas fa-info-circle"></i> <strong>Airport Transfer:</strong> One of your locations must be Nashville International Airport (BNA).`;
      const pickupContainer = document.getElementById("pickup-container");
      pickupContainer.parentNode.insertBefore(airportRequirementBox, pickupContainer);
    } else {
      airportRequirementBox.className = "airport-requirement active";
    }
  } else {
    const airportRequirementBox = document.getElementById("airport-requirement-box");
    if (airportRequirementBox) {
      airportRequirementBox.className = "airport-requirement";
    }
  }
  
  document.getElementById("add-stop-container").style.display = (isPointToPoint || isTransfer) ? "block" : "none";
  document.getElementById("airport-pickup-indicator").style.display = isTransfer ? "inline" : "none";
  document.getElementById("airport-dropoff-indicator").style.display = isTransfer ? "inline" : "none";
  document.getElementById("airport-fields").style.display = isTransfer ? "block" : "none";
  document.getElementById("luggage-container").style.display = isHourly ? "none" : "block";
  document.getElementById("passengers-container").style.display = isHourly ? "none" : "block";
  document.getElementById("kids-container").style.display = isHourly ? "none" : "block";
  
  if (!isHourly) {
    document.getElementById("transfer-special-request-container").style.display = isPointToPoint ? "block" : "block";
    document.getElementById("hourly-itinerary-container").style.display = "none";
    document.getElementById("duration-container").style.display = "none";
    document.getElementById("trip-type-container").style.display = "none";
    document.getElementById("dropoff-container").style.display = "block";
    document.getElementById("location-type").value = isTransfer ? "airport" : "all";
    document.getElementById("location-type-container").style.display = "none";
    document.getElementById("airport-fields").style.display = isTransfer ? "block" : "none";
    document.getElementById("flight-type-container").style.display = "none";
    document.getElementById("airport-pickup-indicator").style.display = isTransfer ? "inline" : "none";
    document.getElementById("airport-dropoff-indicator").style.display = isTransfer ? "inline" : "none";
    document.getElementById("vehicle-section").classList.add("hidden");
    document.querySelectorAll(".vehicle").forEach(v => v.classList.remove("selected"));
    document.getElementById("checkout-button").classList.add("hidden");
    
    if (wasHourly || document.getElementById("passengers").value === "") {
      document.getElementById("passengers").value = 1;
    }
    if (wasHourly || document.getElementById("kids").value === "") {
      document.getElementById("kids").value = 0;
    }
    document.getElementById("luggage").value = 0;
    
    if (isPointToPoint) {
      document.getElementById("dropoff").value = "";
    }
    
    const p = document.getElementById("pickup").value.toLowerCase();
    document.getElementById("arrival-fields").style.display = isTransfer && isBNAAirport(p) ? "block" : "none";
    document.getElementById("departure-fields").style.display = "none";
    
    if (isTransfer) {
      document.querySelector('label[for="transfer-special-request"]').textContent = "Special Request (Airport Transfer)";
    } else {
      document.querySelector('label[for="transfer-special-request"]').textContent = "Special Request:";
    }
  } else {
    document.getElementById("transfer-special-request-container").style.display = "none";
    document.getElementById("hourly-itinerary-container").style.display = "block";
    document.getElementById("duration-container").style.display = "block";
    document.getElementById("trip-type-container").style.display = "none";
    document.getElementById("dropoff-container").style.display = "none";
    document.getElementById("trip-hours").value = 3;
    document.getElementById("hours-display").textContent = 3;
    document.getElementById("location-type-container").style.display = "none";
    document.getElementById("airport-pickup-indicator").style.display = "none";
    document.getElementById("airport-dropoff-indicator").style.display = "none";
    document.getElementById("airport-fields").style.display = "none";
    document.getElementById("arrival-fields").style.display = "none";
    document.getElementById("departure-fields").style.display = "none";
    document.getElementById("hourly-itinerary").value = "";
    document.getElementById("pickup").style.borderColor = "";
    updateFixedHourlyPrice();
    document.getElementById("vehicle-section").classList.remove("hidden");
    lVBPC();
    const hours = parseInt(document.getElementById("trip-hours").value) || 3;
    const hourlyRate = PR.HR;
    const total = hours * hourlyRate;
    
    const priceDetails = {
      baseFare: hours * hourlyRate,
      total: total,
      details: {
        hours: hours,
        hourlyRate: hourlyRate
      }
    };
    lPDet = priceDetails;
    document.getElementById("checkout-button").setAttribute("data-price", total.toFixed(2));
  }
  
  document.getElementById("pickup-date").value = currentDate;
  document.getElementById("pickup-time").value = currentTime;
  document.getElementById("phone").value = currentPhone;
  document.getElementById("email").value = currentEmail;
  document.getElementById("first-name").value = currentFirstName;
  document.getElementById("last-name").value = currentLastName;
  document.getElementById("pickup").value = currentPickup;
  
  setTimeout(function() {
    document.getElementById("luggage-container").style.display = isHourly ? "none" : "block";
    document.getElementById("passengers-container").style.display = isHourly ? "none" : "block";
    document.getElementById("kids-container").style.display = isHourly ? "none" : "block";
  }, 100);
  
  if (isHourly || isPointToPoint) {
    setTimeout(function() {
      document.getElementById("airport-pickup-indicator").style.display = "none";
      document.getElementById("airport-dropoff-indicator").style.display = "none";
      document.getElementById("pickup").style.borderColor = "";
    }, 200);
  }
  
  setTimeout(uM, 300);
  document.querySelectorAll(".error-field").forEach(el => el.classList.remove("error-field"));
  
  if (!isHourly) {
    lVBPC();
  }
  
  return false;
}
function initMapDisplay(){const mapFrame = document.getElementById("map-frame");if (!mapFrame) {console.error("Map frame element not found");return;}try {const loadingEl = document.getElementById("map-loading");if (loadingEl) {loadingEl.style.opacity = "1";}mapFrame.style.opacity = "0.6";const isMobile = window.innerWidth < 768;const zoom = isMobile ? "9" : "10";const mapUrl = `https://www.google.com/maps/embed/v1/place?key=AIzaSyBECPPi3uRa4A5CQ7-zIvQ3ooJu3g9EQKg&q=Nashville,Tennessee&zoom=${zoom}`;mapFrame.src = mapUrl;mapFrame.onload = function() {if (loadingEl) {loadingEl.style.opacity = "0";}mapFrame.style.opacity = "1";console.log("Map loaded successfully");};setTimeout(() => {if (loadingEl) {loadingEl.style.opacity = "0";}mapFrame.style.opacity = "1";console.log("Map loading timeout reached, forcing display");}, 5000);} catch (error) {console.error("Error initializing map:", error);try {mapFrame.src = "https://www.google.com/maps/embed/v1/place?key=AIzaSyBECPPi3uRa4A5CQ7-zIvQ3ooJu3g9EQKg&q=Nashville,TN";} catch (e) {console.error("Failed to load fallback map:", e);}}}
function ensureGoogleMapsLoaded(){if (typeof google === 'undefined' || typeof google.maps === 'undefined') {console.log("Google Maps API not loaded yet, retrying...");setTimeout(ensureGoogleMapsLoaded, 1000);return;}console.log("Google Maps API loaded successfully");if (typeof initAC === 'function') {try {initAC();} catch (e) {console.error("Error initializing autocomplete:", e);}}}
function toggleStopContainer(){const bookingType = document.getElementById("booking-type").value;const stopContainer = document.getElementById("add-stop-container");stopContainer.style.display = (bookingType === "transfer" || bookingType === "point-to-point") ? "block" : "none";}document.addEventListener("DOMContentLoaded", () => {const addStopContainer = document.getElementById("add-stop-container");const existingButtons = addStopContainer.querySelectorAll("button");existingButtons.forEach(button => button.remove());const addStopButton = document.createElement("button");addStopButton.textContent = "Add Stop";addStopButton.type = "button";addStopButton.onclick = addStop;addStopContainer.appendChild(addStopButton);});
function addStop(){if(typeof window.stopCount==='undefined'){window.stopCount=0;}window.stopCount++;const stopContainer=document.getElementById("stops-container");if(!stopContainer){console.error("Stops container not found");return;}const stopDiv=document.createElement("div");stopDiv.classList.add("stop");stopDiv.setAttribute("id",`stop-${window.stopCount}`);const stopInput=document.createElement("input");stopInput.setAttribute("type","text");stopInput.setAttribute("class","autocomplete");stopInput.setAttribute("name",`stop-${window.stopCount}`);stopInput.setAttribute("placeholder",`Stop ${window.stopCount}`);stopInput.addEventListener("input",function(){if(typeof dMU==='function')dMU();});const deleteButton=document.createElement("button");deleteButton.innerHTML="<i class='fas fa-times'></i>";deleteButton.classList.add("remove-button");deleteButton.type="button";deleteButton.onclick=function(){stopDiv.remove();if(typeof dMU==='function')dMU();};stopDiv.appendChild(stopInput);stopDiv.appendChild(deleteButton);stopContainer.appendChild(stopDiv);if(typeof iACF==='function'){try{iACF(stopInput);}catch(e){console.error("Error initializing autocomplete for stop:",e);}}console.log(`Added stop #${window.stopCount}`);}
// ===== NUEVA FUNCIÓN: Construcción optimizada de URL del mapa ===== 
function buildOptimizedMapSrc(pickup, dropoff, stops = []) {
  const encodedPickup = encodeURIComponent(pickup.trim());
  const encodedDropoff = encodeURIComponent(dropoff.trim());
  const encodedStops = stops.map(stop => encodeURIComponent(stop.trim())).join('%7C');
  
  let mapSrc = `https://www.google.com/maps/embed/v1/directions?key=AIzaSyBECPPi3uRa4A5CQ7-zIvQ3ooJu3g9EQKg&origin=${encodedPickup}&destination=${encodedDropoff}`;
  
  if (encodedStops) {
    mapSrc += `&waypoints=${encodedStops}`;
  }
  
  mapSrc += '&mode=driving';
  
  
  console.log("🗺️ URL del mapa construida:", mapSrc);
  return mapSrc;
}
async function cHP() {
  const hours = parseInt(document.getElementById("trip-hours").value) || 3;
  
  // Obtener el vehículo seleccionado (consistente con cTP)
  const selectedVehicle = document.querySelector('.vehicle.selected');
  const isVehicleSelected = selectedVehicle !== null;
  const isSUV = isVehicleSelected && selectedVehicle.id === 'cadillac';
  
  // Si no hay vehículo seleccionado, usar tarifas SUV (precio más alto)
  const hourlyRate = isVehicleSelected ? (isSUV ? PR.SUV_HR : PR.HR) : PR.SUV_HR;
  
  const total = hours * hourlyRate;
  
  console.log("=== 💰 CÁLCULO DE PRECIO POR HORA ===");
  console.log("🕒 Horas:", hours);
  console.log("🚗 Vehículo seleccionado:", isVehicleSelected ? (isSUV ? "SUV" : "Sedan/Truck") : "Por defecto (SUV)");
  console.log("💵 Tarifa por hora:", hourlyRate.toFixed(2));
  console.log("💵 Total calculado: $", total.toFixed(2));
  console.log("================================");
  
  return {
    baseFare: hours * hourlyRate,
    total: total,
    details: {
      hours: hours,
      hourlyRate: hourlyRate,
      isVehicleSelected: isVehicleSelected,
      isSUV: isSUV
    }
  };
}
async function uM() {
  const isMobile = window.innerWidth < 768;
  console.log("uM function called - updating map and calculating prices on " + 
    (isMobile ? "mobile device" : "desktop"), "screen width:", window.innerWidth);
  
  const loadingEl = document.getElementById("map-loading");
  const mapFrame = document.getElementById("map-frame");
  const mapContainer = document.getElementById("map-container");
  const pickup = document.getElementById("pickup").value;
  const bookingType = document.getElementById("booking-type").value;
  
  // Log map container dimensions for debugging
  if (mapContainer) {
    const rect = mapContainer.getBoundingClientRect();
    console.log("Map container dimensions:", {
      width: rect.width,
      height: rect.height,
      visible: rect.width > 0 && rect.height > 0
    });
  }
  
  // Show loading indicators
  if (loadingEl) loadingEl.style.opacity = "1";
  if (mapFrame) mapFrame.style.opacity = "0.6";
  
  // Handle hourly booking type
  if (bookingType === "hourly") {
    if (!pickup) {
      console.log("No pickup location for hourly booking, showing default map");
      showDefaultMap();
      return;
    }
    
    const encodedPickup = encodeURIComponent(pickup.trim());
    try {
      // Adjust zoom level for mobile devices
      const zoom = isMobile ? "11" : "12";
      const mapSrc = `https://www.google.com/maps/embed/v1/place?key=AIzaSyBECPPi3uRa4A5CQ7-zIvQ3ooJu3g9EQKg&q=${encodedPickup}&zoom=${zoom}`;
      
      console.log("Setting hourly map source:", mapSrc);
      
      if (mapFrame) {
        // Force reload on mobile to prevent caching issues
        if (isMobile) {
          mapFrame.src = "about:blank";
          await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        mapFrame.src = mapSrc;
        
        // Set up load handler
        mapFrame.onload = function() {
          console.log("Map frame loaded successfully");
          if (loadingEl) loadingEl.style.opacity = "0";
          mapFrame.style.opacity = "1";
        };
        
        // Fallback in case onload doesn't fire
        setTimeout(() => {
          console.log("Map load timeout reached, finishing load sequence");
          if (loadingEl) loadingEl.style.opacity = "0";
          mapFrame.style.opacity = "1";
        }, 3000);
      }
      
      // Calculate hourly price
      try {
        const hourlyPrice = await cHP();
        uPD(hourlyPrice);
      } catch (priceError) {
        console.error("Error calculating hourly price:", priceError);
      }
    } catch (e) {
      console.error("Map update error for hourly booking:", e);
      showDefaultMap();
    }
    return;
  }
  
  // Handle transfer or point-to-point booking types
  const dropoff = document.getElementById("dropoff").value;
  if (!pickup || !dropoff) {
    console.log("Missing pickup or dropoff - showing default map");
    showDefaultMap();
    const priceContainer = document.getElementById("price-breakdown");
    if (priceContainer && document.getElementById("price-loading")) {
      priceContainer.innerHTML = '';
    }
    return;
  }
  
  // Process stops
  const stops = [...document.querySelectorAll("#stops-container .autocomplete")]
    .map(input => input.value)
    .filter(val => val.trim() !== "");
  
  console.log("Stops detected:", stops.length > 0 ? stops : "none");
  
  // Prepare URL components
  const encodedPickup = encodeURIComponent(pickup.trim());
  const encodedDropoff = encodeURIComponent(dropoff.trim());
  const encodedStops = stops.map(stop => encodeURIComponent(stop.trim())).join('%7C');
  
  console.log(`Updating map from ${pickup} to ${dropoff}`);
  
  try {
    // Build directions URL with proper encoding
    const mapSrc = buildOptimizedMapSrc(pickup, dropoff, stops);
    
    console.log("Setting directions map source:", mapSrc);    
    console.log("Setting directions map source:", mapSrc);
    
    if (mapFrame) {
      // Force reload on mobile to prevent caching issues
      if (isMobile) {
        mapFrame.src = "about:blank";
        await new Promise(resolve => setTimeout(resolve, 50));
      }
      
      // Set the iframe source to the directions URL
      mapFrame.src = mapSrc;
      
      // Set up load handler
      mapFrame.onload = function() {
        console.log("Directions map loaded successfully");
        if (loadingEl) loadingEl.style.opacity = "0";
        mapFrame.style.opacity = "1";
      };
      
      // Fallback in case onload doesn't fire
      setTimeout(() => {
        console.log("Map load timeout reached, finishing load sequence");
        if (loadingEl) loadingEl.style.opacity = "0";
        mapFrame.style.opacity = "1";
      }, 3000);
    }
    
    // Calculate price for transfer or point-to-point
    if (["transfer", "point-to-point"].includes(bookingType)) {
      try {
        console.log("Calculating price for route...");
        const priceDetails = await cTP(pickup, dropoff, stops, document.getElementById("passengers").value);
        console.log("Price calculation successful:", priceDetails);
        uPD(priceDetails);
      } catch (priceError) {
        console.error("Error calculating price:", priceError);
        const priceContainer = document.getElementById("price-breakdown");
        if (priceContainer) {
          priceContainer.innerHTML = `<div class="price-details"><div class="price-item" style="color: #e74c3c;"><span><i class="fas fa-exclamation-circle"></i> Unable to calculate price:</span><span>${priceError.message || 'Please check your route and try again'}</span></div></div>`;
        }
      }
    }
  } catch (e) {
    console.error("Map update error:", e);
    console.error("Error details:", e.message);
    console.error("Stack trace:", e.stack);
    showDefaultMap();
  }
}
function cRD(origin, destination, stops = []) {
  try {
    const directionsService = new google.maps.DirectionsService();
    const waypoints = stops.map(stop => ({
      location: stop,
      stopover: true
    }));
    
    // Usar la nueva función para gestión inteligente de tiempos
    const timeInfo = getOptimalDepartureTime();
    const departureTime = timeInfo.time;
    
    // Configuración base de la solicitud
    const request = {
  origin: origin,
  destination: destination,
  waypoints: waypoints,
  travelMode: google.maps.TravelMode.DRIVING,
  provideRouteAlternatives: true,  // Obtener múltiples rutas
  optimizeWaypoints: false,         // No optimizar el orden de waypoints
  avoidHighways: false,            // Permitir autopistas
  avoidTolls: false               // Permitir peajes
};
    
    // Solo añadir drivingOptions si no estamos usando tiempo actual
    if (!timeInfo.shouldUseCurrentTraffic) {
      request.drivingOptions = {
        departureTime: departureTime,
        trafficModel: google.maps.TrafficModel.BEST_GUESS
      };
      console.log("🚗 Usando tráfico predictivo para:", departureTime.toLocaleString());
    } else {
      console.log("🚗 Usando tráfico actual en tiempo real");
    }
    
    return new Promise((resolve, reject) => {
      directionsService.route(request, function(result, status) {
        if (status === google.maps.DirectionsStatus.OK) {
          // Usar la ruta más corta en distancia, no necesariamente la más rápida en tiempo
          let selectedRoute = result.routes[0];
          
          // Si hay múltiples rutas, seleccionar la que tenga menor distancia
          if (result.routes.length > 1) {
            let fastestTime = Infinity;
            for (let route of result.routes) {
              const routeTime = route.legs.reduce((sum, leg) => sum + leg.duration.value, 0);
              if (routeTime < fastestTime) {
                fastestTime = routeTime;
                selectedRoute = route;
              }
            }
            console.log(`Seleccionada la ruta más rápida de ${result.routes.length} opciones disponibles`);
          }
          
          const legs = selectedRoute.legs;
          const distanceTexts = legs.map(leg => leg.distance.text);
          const durationTexts = legs.map(leg => leg.duration.text);
          const totalDistanceMeters = legs.reduce((sum, leg) => sum + leg.distance.value, 0);
          const totalDistanceMiles = totalDistanceMeters / 1609.34;
          const totalSeconds = legs.reduce((sum, leg) => sum + leg.duration.value, 0);
          const arrivalTime = new Date(departureTime.getTime() + (totalSeconds * 1000));
          
          // NUEVO: Logging detallado para debugging
          console.log("=== 🗺️ DETALLES DE RUTA GOOGLE MAPS ===");
          console.log("🕒 Tiempo de salida usado:", departureTime.toLocaleString());
          console.log("⏱️ Tiempo actual:", new Date().toLocaleString());
          console.log("🚦 Tipo de tráfico:", timeInfo.shouldUseCurrentTraffic ? "TIEMPO REAL" : "PREDICTIVO");
          console.log("📏 Distancia total:", totalDistanceMiles.toFixed(2), "millas");
          console.log("⏰ Duración Google Maps:", durationTexts.join(' + '));
          console.log("🏁 Tiempo estimado de llegada:", arrivalTime.toLocaleString());
          console.log("💡 Razón para selección de tiempo:", timeInfo.reason);
          console.log("=====================================");
          
          // Store complete information in routeData global
          routeData = {
            distanceTexts: distanceTexts,
            durationTexts: durationTexts,
            totalDistanceMeters: totalDistanceMeters,
            totalSeconds: totalSeconds,
            legs: legs,
            timeInfo: timeInfo  // Guardar info de tiempo para referencia
          };
          
          console.log("Google Maps textos de duración:", durationTexts.join(' + '));
          console.log("Google Maps textos de distancia:", distanceTexts.join(' + '));
          console.log("Google Maps distancia total (millas):", totalDistanceMiles.toFixed(2));
          
          resolve({
            totalMiles: totalDistanceMiles,
            googleDurationText: durationTexts.length === 1 ? durationTexts[0] : durationTexts.join(' + '),
            googleDistanceText: distanceTexts.length === 1 ? distanceTexts[0] : distanceTexts.join(' + '),
            useTrafficTime: true,
            departureTime: departureTime,
            arrivalTime: arrivalTime,
            actualRoute: result.routes[0],
            legs: legs,
            timeInfo: timeInfo
          });
        } else {
          reject(`Error en la solicitud de direcciones: ${status}`);
        }
      });
    });
  } catch (error) {
    console.error("Error en función cRD:", error);
    throw error;
  }
}
// ===== PASO 3: REEMPLAZAR COMPLETAMENTE LA FUNCIÓN cTP EXISTENTE =====

async function cTP(origin, destination, stops, passengers) {
  try {
    // Obtener tiempo de salida para la ruta
    const departureTimeForRoute = window.selectedDepartureTime || new Date();
    console.log("=== INICIANDO CÁLCULO DE PRECIO ===");
    console.log("Llamando a cRD con:", origin, destination, stops);
    
    // Obtener detalles de la ruta desde Google Maps
    const routeDetails = await cRD(origin, destination, stops);
    console.log("Detalles de ruta recibidos:", routeDetails);
    
    // Validar que recibimos datos válidos
    if (!routeDetails || typeof routeDetails.totalMiles !== 'number') {
      throw new Error("Datos de ruta inválidos recibidos");
    }
    
    // Extraer datos básicos de la ruta
    const totalMiles = routeDetails.totalMiles;
    const googleDurationText = routeDetails.googleDurationText;
    const googleDistanceText = routeDetails.googleDistanceText;
    const totalSeconds = routeData.totalSeconds;
    const totalMinutes = Math.round(totalSeconds / 60);

    console.log("Procesando tiempos:");
    console.log("   Segundos totales:", totalSeconds);
    console.log("   Minutos totales para pricing:", totalMinutes);
    console.log("   Google Maps duración:", googleDurationText);
    
    // Obtener precios apropiados según el tipo de booking
    const bookingType = document.getElementById("booking-type").value;
    const areaPricing = (bookingType === "transfer") ? 
      getAreaBasedPricing(origin, destination) : 
      (bookingType === "point-to-point") ?
      getAreaBasedPricing(origin, destination, totalMiles) :
      {
        area: 'default',
        baseFare: PR.BF,
        suvBaseFare: PR.SUV_BF,
        areaName: 'Standard',
        level: 0
      };
    
    // Determinar el vehículo seleccionado y aplicar tarifas por área
    const selectedVehicle = document.querySelector('.vehicle.selected');
    const isVehicleSelected = selectedVehicle !== null;
    const isSUV = isVehicleSelected && selectedVehicle.id === 'cadillac';
    
    // Usar tarifas base por área para Airport Transfers y por distancia para Point-to-Point
    const baseFare = isVehicleSelected ? 
      (isSUV ? areaPricing.suvBaseFare : areaPricing.baseFare) : 
      areaPricing.suvBaseFare;
    
    // ELIMINADO: const ratePerMile = ...
    // ELIMINADO: const ratePerMinute = ...

    // Calcular costos individuales
    const passengersAdults = parseInt(passengers) || 0;
    const passengersKids = parseInt(document.getElementById("kids").value) || 0;
    const distanceCost = 0; // ELIMINADO: totalMiles * ratePerMile;
    const passengerCost = (document.getElementById("booking-type").value === "hourly") ? 0 : (passengersAdults + passengersKids) * PR.PP;
    const timeCost = 0; // ELIMINADO: totalMinutes * ratePerMinute;
    
    // Calcular subtotal inicial
    let subtotal = baseFare + distanceCost + passengerCost + timeCost;
    const airportFee = (document.getElementById("booking-type").value === "transfer") ? PR.AF : 0;
    subtotal += airportFee;
    
    // Aplicar lógica de tarifa mínima
    let finalSubtotal = subtotal;
    let minimumFareApplied = false;
    
    if (totalMiles <= PR.MIN_DISTANCE) {
      if (subtotal < PR.MIN_FARE) {
        finalSubtotal = PR.MIN_FARE;
        minimumFareApplied = true;
        
        console.log("=== TARIFA MÍNIMA APLICADA ===");
        console.log("Distancia:", totalMiles.toFixed(2), "millas (≤", PR.MIN_DISTANCE, "millas)");
        console.log("Subtotal calculado: $" + subtotal.toFixed(2));
        console.log("Tarifa mínima: $" + PR.MIN_FARE.toFixed(2));
        console.log("Usando tarifa mínima de $" + PR.MIN_FARE.toFixed(2));
        console.log("============================");
      }
    }
    
    // Continuar con el cálculo de tarifas adicionales
    const serviceFee = finalSubtotal * PR.SFR;
    const pretaxTotal = finalSubtotal + serviceFee;
    const tax = pretaxTotal * PR.TR;
    const total = pretaxTotal + tax;
    
    // LOGGING MEJORADO
    console.log("=== CÁLCULO DE PRECIOS SIN TIEMPO/DISTANCIA ===");
    
    if (bookingType === "transfer") {
      console.log("ÁREA DETECTADA:", areaPricing.areaName, `(${areaPricing.area}) - Nivel ${areaPricing.level}`);
      console.log("Precio base área:", "$" + areaPricing.baseFare.toFixed(2));
      console.log("Precio base SUV área:", "$" + areaPricing.suvBaseFare.toFixed(2));
      console.log("Precio base aplicado:", "$" + baseFare.toFixed(2));
    } else if (bookingType === "point-to-point") {
      console.log("POINT-TO-POINT POR DISTANCIA:");
      console.log("Distancia de ruta:", totalMiles.toFixed(2), "millas");
      console.log("Precio base Sedan:", "$" + areaPricing.baseFare.toFixed(2));
      console.log("Precio base SUV:", "$" + areaPricing.suvBaseFare.toFixed(2));
      console.log("Precio base aplicado:", "$" + baseFare.toFixed(2));
    }
    
    console.log("COSTOS CALCULADOS:");
    console.log("   Tarifa base:", "$" + baseFare.toFixed(2));
    console.log("   Costo por distancia: $0.00 (ELIMINADO)");
    console.log("   Costo por tiempo: $0.00 (ELIMINADO)");
    console.log("   Costo por pasajeros (" + (passengersAdults + passengersKids) + " × $" + PR.PP + "):", "$" + passengerCost.toFixed(2));
    console.log("   Tarifa de aeropuerto:", "$" + airportFee.toFixed(2));
    console.log("   Subtotal inicial:", "$" + subtotal.toFixed(2));
    
    if (minimumFareApplied) {
      console.log("   TARIFA MÍNIMA APLICADA:", "$" + PR.MIN_FARE.toFixed(2), "(distancia ≤", PR.MIN_DISTANCE, "millas)");
      console.log("   Subtotal ajustado:", "$" + finalSubtotal.toFixed(2));
    }
    
    console.log("   Service Fee (5%):", "$" + serviceFee.toFixed(2));
    console.log("   Tax (9.75%):", "$" + tax.toFixed(2));
    console.log("   TOTAL FINAL:", "$" + total.toFixed(2));
    console.log("================================================");
    
    // Retornar objeto completo
    return {
      baseFare: baseFare,
      distanceCost: 0, // CAMBIADO
      timeCost: 0, // CAMBIADO
      passengerCost: passengerCost,
      airportFee: airportFee,
      subtotal: finalSubtotal,
      serviceFee: serviceFee,
      tax: tax,
      total: total,
      minimumFareApplied: minimumFareApplied,
      originalSubtotal: subtotal,
      areaPricing: areaPricing,
      details: {
        miles: totalMiles,
        googleDurationText: googleDurationText,
        googleDistanceText: googleDistanceText,
        totalSeconds: totalSeconds,
        totalMinutes: totalMinutes,
        pricePerMinute: 0, // CAMBIADO
        pricePerMile: 0, // CAMBIADO
        baseFareAmount: baseFare,
        isVehicleSelected: isVehicleSelected,
        isSUV: isSUV,
        vehicleType: isVehicleSelected ? (isSUV ? "SUV" : "Sedan/Truck") : "Default SUV",
        passengersAdults: passengersAdults,
        passengersKids: passengersKids,
        totalPassengers: passengersAdults + passengersKids,
        useTrafficTime: true,
        departureTime: departureTimeForRoute,
        arrivalTime: new Date(departureTimeForRoute.getTime() + (totalSeconds * 1000)),
        legs: routeDetails.legs || [],
        routeData: routeData,
        minimumFareApplied: minimumFareApplied,
        originalSubtotal: subtotal,
        finalSubtotal: finalSubtotal,
        minimumFare: PR.MIN_FARE,
        minimumDistance: PR.MIN_DISTANCE,
        distanceQualifiesForMinimum: totalMiles <= PR.MIN_DISTANCE,
        bookingType: document.getElementById("booking-type").value,
        hasStops: stops && stops.length > 0,
        stopsCount: stops ? stops.length : 0,
        calculationTimestamp: new Date().toISOString(),
        routeDetails: routeDetails,
        areaDetected: areaPricing.area,
        areaName: areaPricing.areaName,
        originalBaseFare: isSUV ? PR.SUV_BF : PR.BF,
        areaBaseFare: baseFare,
        pricingAdjustment: baseFare - (isSUV ? PR.SUV_BF : PR.BF),
        distanceMiles: bookingType === "point-to-point" ? totalMiles : undefined,
        distancePricingApplied: bookingType === "point-to-point"
      }
    };
    
  } catch (error) {
    console.error("=== ERROR EN CÁLCULO DE PRECIO ===");
    console.error("Error completo:", error);
    console.error("Stack trace:", error.stack);
    console.error("Parámetros recibidos:", { origin, destination, stops, passengers });
    console.error("====================================");
    
    throw new Error("Error calculando precio: " + (error.message || "Por favor verifica tu ruta e intenta de nuevo"));
  }
}
function uPWM(){console.log("Price update completed");}
function tAF() {const e = document.getElementById("airport-fields");const t = document.getElementById("flight-type-container");const n = document.getElementById("arrival-fields");const o = document.getElementById("departure-fields");const bookingType = document.getElementById("booking-type").value;if (bookingType !== "transfer") {e.style.display = "none";t.style.display = "none";n.style.display = "none";o.style.display = "none";return;}e.style.display = "block";t.style.display = "none";const r = document.getElementById("pickup").value.toLowerCase();const a = document.getElementById("dropoff").value.toLowerCase();const c = isBNAAirport(r);const d = isBNAAirport(a);c ? (n.style.display = "block",document.getElementById("flight-type").value = "arrival") : n.style.display = "none";d ? (o.style.display = "block",c || (document.getElementById("flight-type").value = "departure")) : o.style.display = "none";uPWM();}
function uPD(priceDetails) {
  console.log("Actualizando detalles de precio:", priceDetails);
  const bookingType = document.getElementById("booking-type").value;
  const priceContainer = document.getElementById("price-breakdown");
  
  if (bookingType === "hourly") {
    // Para modo hourly, NO actualizar el price-breakdown
    priceContainer.innerHTML = '';
  } else if (bookingType === "transfer" || bookingType === "point-to-point") {
    // Para transfer y point-to-point, mostrar el desglose SIN tiempo y distancia
    let serviceTitle = "Point-to-Point Pricing";
    if (bookingType === "transfer") {
      serviceTitle = "Airport Transfer Pricing";
    } else if (bookingType === "point-to-point" && priceDetails.areaPricing && priceDetails.areaPricing.distanceMiles) {
      serviceTitle = `Point-to-Point Pricing (${priceDetails.areaPricing.distanceMiles.toFixed(1)} miles)`;
    }
    
    priceContainer.innerHTML = `
      <div class="price-details">
        <h3><i class="fas fa-file-invoice-dollar"></i> ${serviceTitle}</h3>
        
        <!-- Price Summary -->
        <div class="price-summary" onclick="togglePriceDetails()">
          <div class="price-summary-content">
            <div class="price-item total">
              <span><i class="fas fa-money-check-alt"></i> Total:</span>
              <span>$${priceDetails.total.toFixed(2)}</span>
            </div>
            <div class="more-details-toggle">
              <span>More details</span>
              <i class="fas fa-chevron-down"></i>
            </div>
          </div>
        </div>
        
        <!-- Collapsible Details -->
        <div id="price-breakdown-details" class="price-breakdown-details collapsed">
          <div class="price-breakdown-content">
            <div class="price-item">
              <span><i class="fas fa-car"></i> Base Fare:</span>
              <span>$${priceDetails.baseFare.toFixed(2)}</span>
            </div>
            ${bookingType === "transfer" && priceDetails.airportFee > 0 ? 
              `<div class="price-item">
                <span><i class="fas fa-plane"></i> Airport Fee:</span>
                <span>$${priceDetails.airportFee.toFixed(2)}</span>
              </div>` : ""}
            <div class="price-item">
              <span><i class="fas fa-tools"></i> Service Fee (5%):</span>
              <span>$${priceDetails.serviceFee.toFixed(2)}</span>
            </div>
            <div class="price-item">
              <span><i class="fas fa-receipt"></i> Tax (9.75%):</span>
              <span>$${priceDetails.tax.toFixed(2)}</span>
            </div>
          </div>
        </div>
      </div>`;
  }
  
  // Actualizar el precio en el botón de checkout para todos los modos
  if (priceDetails && priceDetails.total) {
    document.getElementById("checkout-button").setAttribute("data-price", priceDetails.total.toFixed(2));
  }
  
  // Guardar los detalles del precio globalmente
  lPDet = priceDetails;
}
function updateFixedHourlyPrice() {
  const hours = parseInt(document.getElementById("trip-hours").value) || 3;
  
  // Usar la misma lógica que en cTP() y cHP()
  const selectedVehicle = document.querySelector('.vehicle.selected');
  const isVehicleSelected = selectedVehicle !== null;
  const isSUV = isVehicleSelected && selectedVehicle.id === 'cadillac';
  
  // Si no hay vehículo seleccionado, usar tarifas SUV
  const hourlyRate = isVehicleSelected ? (isSUV ? PR.SUV_HR : PR.HR) : PR.SUV_HR;
  
  const total = hours * hourlyRate;
  
  // Actualizar todos los elementos visuales
  document.getElementById("fixed-hours-display").textContent = hours;
  document.getElementById("fixed-rate").textContent = hourlyRate.toFixed(2);
  document.getElementById("fixed-price").textContent = (hours * hourlyRate).toFixed(2);
  document.getElementById("fixed-total").textContent = total.toFixed(2);
  
  // Actualizar el precio del botón de checkout
  if (document.getElementById("checkout-button")) {
    document.getElementById("checkout-button").setAttribute("data-price", total.toFixed(2));
  }
  
  // Guardar detalles para consistencia
  lPDet = {
    baseFare: hours * hourlyRate,
    total: total,
    details: {
      hours: hours,
      hourlyRate: hourlyRate,
      isVehicleSelected: isVehicleSelected,
      isSUV: isSUV
    }
  };
  
  console.log("✅ Updated hourly price:", total.toFixed(2), 
             "Rate:", hourlyRate, 
             "Vehicle:", isVehicleSelected ? (isSUV ? "SUV" : "Sedan") : "Default SUV");
}
function aPL(){setupPassengerListeners();}
function fBD(e){
  const noStopsMessage="  • Direct route with no stops";
  const n=e.priceDetails||{};
  const bookingTypeLabel="transfer"===e.bookingType?"AIRPORT TRANSFER":"HOURLY";
  let flightInfo="";
  
  if("transfer"===e.bookingType){
    e.flightInfo&&(flightInfo+=`\nArrival Flight Info: • Airline: ${e.flightInfo.airline} • Flight Number: ${e.flightInfo.flightNumber} • Flight Time: ${e.flightInfo.flightTime||"Not provided"}`);
    e.departureInfo&&(flightInfo+=`\nDeparture Flight Info:  • Airline: ${e.departureInfo.airline}  • Flight Number: ${e.departureInfo.flightNumber}  • Flight Time: ${e.departureInfo.flightTime||"Not provided"}`);
  }
  
  // ACTUALIZADO: Eliminar costos de tiempo y distancia del desglose
  const o=n&&n.total?`Price Breakdown:
- Base Fare: ${(n.baseFare||0).toFixed(2)}
${n.airportFee>0?`• Airport Fee: ${n.airportFee.toFixed(2)}\n`:""}
- Service Fee: ${(n.serviceFee||0).toFixed(2)}
- Tax: ${(n.tax||0).toFixed(2)}
Total: ${(n.total||0).toFixed(2)}`:"";
  
  return`Booking Confirmation
Date: ${e.bookingDate||"N/A"}
Time: ${e.bookingTime||"N/A"}
Booking Type: ${bookingTypeLabel}
${flightInfo}
${"hourly"===e.bookingType?`Hours: ${e.hourly?.hours||"N/A"}
Itinerary: ${e.itinerary||"N/A"}`:`Special Request: ${e.specialRequest||"N/A"}`}
Pickup: ${e.pickup||e.transfer?.pickup||"N/A"}
Dropoff: ${e.dropoff||e.transfer?.dropoff||"N/A"}
Route:${noStopsMessage}
${"hourly"!==e.bookingType?`Passengers: ${e.passengers?.total||1} (Adults: ${e.passengers?.adults||1}, Kids: ${e.passengers?.kids||0})`:""}
Luggage: ${e.passengers?.luggage||0}
Phone: ${e.contact?.phone||"N/A"}
Email: ${e.contact?.email||"N/A"}
Vehicle: ${e.vehicle?e.vehicle.type:"Not Selected"}
${o}`;
}
function sV(){const errors=[];const bookingType=document.getElementById("booking-type").value;const fieldsToValidate={'pickup-date':'Pickup Date','pickup-time':'Pickup Time','pickup':'Pickup Point','phone':'Phone Number','email':'Email','first-name':'First Name','last-name':'Last Name'};if(bookingType==="transfer"||bookingType==="point-to-point"){fieldsToValidate['dropoff']='Drop-off Point';fieldsToValidate['passengers']='Passengers';}for(let[fieldId,fieldName]of Object.entries(fieldsToValidate)){const field=document.getElementById(fieldId);if(!field||!field.value.trim()){errors.push(fieldName);if(field)field.classList.add("error-field");}else{field.classList.remove("error-field");}}if(bookingType==="transfer"){const pickup=document.getElementById("pickup").value;const dropoff=document.getElementById("dropoff").value;if(!isBNAAirport(pickup)&&!isBNAAirport(dropoff)){errors.push("At least one location must be Nashville International Airport (BNA)");document.getElementById("pickup").classList.add("error-field");document.getElementById("dropoff").classList.add("error-field");}}if(bookingType==="transfer"||bookingType==="point-to-point"){const passengersCount=parseInt(document.getElementById("passengers").value)||0;const kidsCount=parseInt(document.getElementById("kids").value)||0;const totalPassengers=passengersCount+kidsCount;if(totalPassengers>4){alert("Para "+(bookingType==="transfer"?"Airport Transfer":"Point-to-Point")+", vehicles are not available for more than 4 passengers. Please reduce the number of passengers.");document.getElementById("passengers").classList.add("error-field");document.getElementById("kids").classList.add("error-field");return false;}}if(bookingType==="point-to-point"){const pickup=document.getElementById("pickup").value;const dropoff=document.getElementById("dropoff").value;if(!pickup||!dropoff){alert("Please provide both pickup and dropoff points for Point-to-Point.");return false;}}const phone=document.getElementById("phone").value.trim();if(phone&&!/^\d{10}$/.test(phone)){errors.push("Valid 10-digit Phone Number");document.getElementById("phone").classList.add("error-field");}const email=document.getElementById("email").value.trim();if(email&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){errors.push("Valid Email Address");document.getElementById("email").classList.add("error-field");}if(errors.length>0){alert("Please correct the following:\n\n"+errors.join("\n"));return false;}document.getElementById("vehicle-section").classList.remove("hidden");lVBPC();return true;}
function tFF(){const e=document.getElementById("flight-type").value,t=document.getElementById("arrival-fields"),n=document.getElementById("departure-fields");t.style.display="arrival"===e?"block":"none",n.style.display="departure"===e?"block":"none"}
function sV2(vehicleId) {
  document.querySelectorAll(".vehicle").forEach(v => v.classList.remove("selected"));
  const selectedVehicle = document.getElementById(vehicleId);
  
  if(!selectedVehicle.classList.contains("vehicle-disabled")) {
    selectedVehicle.classList.add("selected");
    document.getElementById("checkout-button").classList.remove("hidden");
    
    // Forzar recálculo inmediato del precio
    const bookingType = document.getElementById("booking-type").value;
    if(bookingType === "hourly") {
      updateFixedHourlyPrice();
    } else if(bookingType === "transfer" || bookingType === "point-to-point") {
      // Forzar recálculo con el nuevo vehículo seleccionado
      setTimeout(() => {
        const pickup = document.getElementById("pickup").value;
        const dropoff = document.getElementById("dropoff").value;
        if(pickup && dropoff) {
          console.log("Recalculando precio con vehículo:", vehicleId);
          dMU(); // Esto recalculará el precio con el nuevo vehículo
        }
      }, 100);
    }
  }
}
function lVBPC() {
  const passengersCount = parseInt(document.getElementById("passengers").value) || 0;
  const kidsCount = parseInt(document.getElementById("kids").value) || 0;
  const totalPassengers = passengersCount + kidsCount;
  const bookingType = document.getElementById("booking-type").value;
  const shouldApplyLimit = bookingType === "transfer" || bookingType === "point-to-point";
  const toyotaVehicle = document.getElementById("toyota");
  const cadillacVehicle = document.getElementById("cadillac");
  const checkoutButton = document.getElementById("checkout-button");
  const vehicleSection = document.getElementById("vehicle-section");
  
  toyotaVehicle.classList.remove("selected");
  cadillacVehicle.classList.remove("selected");
  checkoutButton.classList.add("hidden");
  
  if (shouldApplyLimit && totalPassengers > 4) {
    toyotaVehicle.classList.add("vehicle-disabled");
    cadillacVehicle.classList.remove("vehicle-disabled");
    
    if (!vehicleSection.classList.contains("hidden")) {
      if (!document.getElementById("passenger-limit-warning")) {
        const warningMessage = document.createElement("div");
        warningMessage.id = "passenger-limit-warning";
        warningMessage.style.backgroundColor = "#f44336";
        warningMessage.style.color = "white";
        warningMessage.style.padding = "10px";
        warningMessage.style.borderRadius = "5px";
        warningMessage.style.marginBottom = "15px";
        warningMessage.style.textAlign = "center";
        warningMessage.innerHTML = "<strong>Attention!</strong> For " + (bookingType === "transfer" ? "Airport Transfer" : "Point-to-Point") + ", vehicles are not available for more than 4 passengers. Please reduce the number of passengers.";
        vehicleSection.insertBefore(warningMessage, vehicleSection.firstChild);
      }
    }
  } else {
    toyotaVehicle.classList.remove("vehicle-disabled");
    cadillacVehicle.classList.remove("vehicle-disabled");
    
    const warningMessage = document.getElementById("passenger-limit-warning");
    if (warningMessage) {
      warningMessage.remove();
    }
  }
}
function setupPassengerListeners() {const passengersField = document.getElementById("passengers");const kidsField = document.getElementById("kids");function updatePassengerLimit() {const bookingType = document.getElementById("booking-type").value;if (bookingType === "transfer" || bookingType === "point-to-point") {lVBPC();dMU();}}passengersField.addEventListener("input", updatePassengerLimit);passengersField.addEventListener("change", updatePassengerLimit);kidsField.addEventListener("input", updatePassengerLimit);kidsField.addEventListener("change", updatePassengerLimit);updatePassengerLimit();}
function updateMapAndPrice() {dMU();}
function getOptimalDepartureTime() {
    const selectedTime = window.selectedDepartureTime;
    const now = new Date();
    
    if (!selectedTime) {
        console.log("⏰ No hay tiempo seleccionado, usando tiempo actual");
        return { 
            time: now, 
            useTraffic: true, 
            reason: "No time selected",
            shouldUseCurrentTraffic: true
        };
    }
    
    const timeDiff = Math.abs(selectedTime.getTime() - now.getTime());
    const thirtyMinutes = 30 * 60 * 1000; // 30 minutos en millisegundos
    
    if (timeDiff < thirtyMinutes) {
        console.log("⏰ Tiempo seleccionado muy cercano al actual, usando tiempo actual para mejor precisión");
        return { 
            time: now, 
            useTraffic: true, 
            reason: "Time too close to current",
            shouldUseCurrentTraffic: true
        };
    }
    
    const isInPast = selectedTime.getTime() < now.getTime();
    if (isInPast) {
        console.log("⏰ Tiempo seleccionado en el pasado, usando tiempo actual");
        return { 
            time: now, 
            useTraffic: true, 
            reason: "Selected time is in the past",
            shouldUseCurrentTraffic: true
        };
    }
    
    console.log("⏰ Usando tiempo seleccionado futuro:", selectedTime);
    return { 
        time: selectedTime, 
        useTraffic: true, 
        reason: "Using selected future time",
        shouldUseCurrentTraffic: false
    };
}
function debugTimeComparison() {
  console.log("=== 🔍 COMPARACIÓN COMPLETA DE TIEMPOS ===");
  
  if (!routeData) {
    console.log("❌ No hay datos de ruta disponibles");
    console.log("   Asegúrate de haber calculado una ruta primero");
    return;
  }
  
  const mapFrame = document.getElementById("map-frame");
  const currentMapSrc = mapFrame ? mapFrame.src : "No disponible";
  
  console.log("🗺️ MAPA VISUAL (iframe):");
  console.log("   URL:", currentMapSrc);
  
  console.log("📊 DATOS DE RUTA (JavaScript API):");
  console.log("   Duración Google Maps:", routeData.durationTexts?.join(' + ') || "N/A");
  console.log("   Distancia Google Maps:", routeData.distanceTexts?.join(' + ') || "N/A");
  console.log("   Segundos totales:", routeData.totalSeconds || "N/A");
  console.log("   Millas totales:", (routeData.totalDistanceMeters / 1609.34).toFixed(2) || "N/A");
  
  if (routeData.timeInfo) {
    console.log("⏰ INFORMACIÓN DE TIEMPO:");
    console.log("   Tiempo usado:", routeData.timeInfo.time.toLocaleString());
    console.log("   Razón:", routeData.timeInfo.reason);
    console.log("   Tráfico actual:", routeData.timeInfo.shouldUseCurrentTraffic ? "SÍ" : "NO");
  }
  
  const priceContainer = document.getElementById("price-breakdown");
  if (priceContainer && priceContainer.innerHTML.includes("Time Cost")) {
    console.log("💰 PRECIO:");
    console.log("   Estado: Calculado y mostrado");
    
    const checkoutButton = document.getElementById("checkout-button");
    const price = checkoutButton ? checkoutButton.getAttribute("data-price") : "N/A";
    console.log("   Total: $" + price);
  } else {
    console.log("💰 PRECIO: No calculado aún");
  }
  
  console.log("🕒 COMPARACIÓN DE TIMESTAMPS:");
  console.log("   Tiempo actual:", new Date().toLocaleString());
  console.log("   Tiempo seleccionado:", window.selectedDepartureTime ? window.selectedDepartureTime.toLocaleString() : "No seleccionado");
  
  console.log("======================================");
}

// Hacer la función disponible globalmente para usar en consola
window.debugTimeComparison = debugTimeComparison;

// Función auxiliar para mostrar estado actual
function getCurrentRouteStatus() {
  const bookingType = document.getElementById("booking-type").value;
  const pickup = document.getElementById("pickup").value;
  const dropoff = document.getElementById("dropoff").value;
  
  console.log("=== 📋 ESTADO ACTUAL ===");
  console.log("Tipo de reserva:", bookingType);
  console.log("Pickup:", pickup || "No especificado");
  console.log("Dropoff:", dropoff || "No especificado");
  console.log("Datos de ruta disponibles:", routeData ? "SÍ" : "NO");
  console.log("======================");
}

window.getCurrentRouteStatus = getCurrentRouteStatus;

function validatePriceConsistency() {
  console.log("=== 🔍 VALIDACIÓN DE CONSISTENCIA DE PRECIOS ===");
  
  // Obtener información básica del estado actual
  const bookingType = document.getElementById("booking-type").value;
  const checkoutButton = document.getElementById("checkout-button");
  const checkoutPrice = checkoutButton ? parseFloat(checkoutButton.getAttribute("data-price")) : null;
  const priceContainer = document.getElementById("price-breakdown");
  
  console.log("📋 ESTADO GENERAL:");
  console.log("   Tipo de reserva:", bookingType);
  console.log("   Precio en botón checkout:", checkoutPrice ? "$" + checkoutPrice.toFixed(2) : "❌ No establecido");
  console.log("   Contenedor de precio visible:", priceContainer && priceContainer.innerHTML.trim() !== "" ? "✅ SÍ" : "❌ NO");
  
  // Variables para seguimiento de consistencia
  let consistencyIssues = [];
  let allGood = true;
  
  // VALIDACIÓN ESPECÍFICA PARA RESERVAS POR HORA
  if (bookingType === "hourly") {
    console.log("\n💰 VALIDACIÓN DE PRECIO POR HORA:");
    
    // Obtener datos del formulario
    const hours = parseInt(document.getElementById("trip-hours").value) || 3;
    const selectedVehicle = document.querySelector('.vehicle.selected');
    const isVehicleSelected = selectedVehicle !== null;
    const isSUV = isVehicleSelected && selectedVehicle.id === 'cadillac';
    
    // Calcular precio esperado
    const hourlyRate = isVehicleSelected ? (isSUV ? PR.SUV_HR : PR.HR) : PR.SUV_HR;
    const expectedPrice = hours * hourlyRate;
    
    console.log("   📊 Cálculo esperado:");
    console.log("     Horas:", hours);
    console.log("     Vehículo seleccionado:", isVehicleSelected ? "✅ SÍ" : "❌ NO");
    console.log("     Tipo de vehículo:", isVehicleSelected ? (isSUV ? "SUV (Cadillac)" : "Sedan/Truck (Toyota)") : "Por defecto (SUV)");
    console.log("     Tarifa por hora:", "$" + hourlyRate.toFixed(2));
    console.log("     Precio esperado:", "$" + expectedPrice.toFixed(2));
    console.log("     Precio en botón:", checkoutPrice ? "$" + checkoutPrice.toFixed(2) : "❌ No establecido");
    
    // Verificar consistencia del botón
    const buttonConsistent = checkoutPrice && Math.abs(expectedPrice - checkoutPrice) < 0.01;
    console.log("     ✅ Botón consistente:", buttonConsistent ? "SÍ" : "❌ NO");
    if (!buttonConsistent) {
      consistencyIssues.push(`Botón checkout: esperado $${expectedPrice.toFixed(2)}, actual $${(checkoutPrice || 0).toFixed(2)}`);
      allGood = false;
    }
    
    // Verificar elementos visuales del precio fijo
    const fixedPriceBox = document.getElementById("fixed-hourly-price");
    if (fixedPriceBox && fixedPriceBox.style.display !== "none") {
      console.log("\n   🖼️ ELEMENTOS VISUALES:");
      
      const fixedHours = document.getElementById("fixed-hours-display").textContent;
      const fixedRate = document.getElementById("fixed-rate").textContent;
      const fixedPrice = document.getElementById("fixed-price").textContent;
      const fixedTotal = document.getElementById("fixed-total").textContent;
      
      console.log("     Horas mostradas:", fixedHours);
      console.log("     Tarifa mostrada:", "$" + fixedRate);
      console.log("     Precio mostrado:", "$" + fixedPrice);
      console.log("     Total mostrado:", "$" + fixedTotal);
      
      // Validar cada elemento
      const hoursConsistent = fixedHours == hours;
      const rateConsistent = Math.abs(parseFloat(fixedRate) - hourlyRate) < 0.01;
      const priceConsistent = Math.abs(parseFloat(fixedPrice) - expectedPrice) < 0.01;
      const totalConsistent = Math.abs(parseFloat(fixedTotal) - expectedPrice) < 0.01;
      
      console.log("     ✅ Horas consistentes:", hoursConsistent ? "SÍ" : "❌ NO");
      console.log("     ✅ Tarifa consistente:", rateConsistent ? "SÍ" : "❌ NO");
      console.log("     ✅ Precio consistente:", priceConsistent ? "SÍ" : "❌ NO");
      console.log("     ✅ Total consistente:", totalConsistent ? "SÍ" : "❌ NO");
      
      if (!hoursConsistent) {
        consistencyIssues.push(`Horas visuales: esperado ${hours}, mostrado ${fixedHours}`);
        allGood = false;
      }
      if (!rateConsistent) {
        consistencyIssues.push(`Tarifa visual: esperado $${hourlyRate.toFixed(2)}, mostrado $${fixedRate}`);
        allGood = false;
      }
      if (!priceConsistent) {
        consistencyIssues.push(`Precio visual: esperado $${expectedPrice.toFixed(2)}, mostrado $${fixedPrice}`);
        allGood = false;
      }
      if (!totalConsistent) {
        consistencyIssues.push(`Total visual: esperado $${expectedPrice.toFixed(2)}, mostrado $${fixedTotal}`);
        allGood = false;
      }
    } else {
      console.log("   ⚠️ Caja de precio fijo no visible");
      consistencyIssues.push("Caja de precio fijo no está visible para reserva por hora");
      allGood = false;
    }
  }
  
  // VALIDACIÓN PARA TRANSFER Y POINT-TO-POINT
  else if (bookingType === "transfer" || bookingType === "point-to-point") {
    console.log("\n🚗 VALIDACIÓN DE PRECIO POR RUTA:");
    
    const pickup = document.getElementById("pickup").value;
    const dropoff = document.getElementById("dropoff").value;
    
    console.log("   📍 Información de ruta:");
    console.log("     Pickup:", pickup || "❌ No especificado");
    console.log("     Dropoff:", dropoff || "❌ No especificado");
    
    if (!pickup || !dropoff) {
      console.log("   ⚠️ Ruta incompleta - no se puede validar precio");
      consistencyIssues.push("Ruta incompleta para validación de precio");
      allGood = false;
    } else {
      // Verificar si hay datos de ruta disponibles
      if (routeData && routeData.totalSeconds) {
        console.log("   📊 Datos de ruta disponibles:");
        console.log("     Distancia:", routeData.totalDistanceMeters ? (routeData.totalDistanceMeters / 1609.34).toFixed(2) + " millas" : "No disponible");
        console.log("     Tiempo:", routeData.durationTexts ? routeData.durationTexts.join(' + ') : "No disponible");
        console.log("     Segundos totales:", routeData.totalSeconds);
        
        // Verificar vehículo seleccionado
        const selectedVehicle = document.querySelector('.vehicle.selected');
        const isVehicleSelected = selectedVehicle !== null;
        const isSUV = isVehicleSelected && selectedVehicle.id === 'cadillac';
        
        console.log("     Vehículo seleccionado:", isVehicleSelected ? "✅ SÍ" : "❌ NO");
        console.log("     Tipo:", isVehicleSelected ? (isSUV ? "SUV" : "Sedan/Truck") : "Por defecto");
        
        if (!isVehicleSelected) {
          consistencyIssues.push("No hay vehículo seleccionado para cálculo de precio");
          allGood = false;
        }
      } else {
        console.log("   ❌ No hay datos de ruta disponibles");
        consistencyIssues.push("Faltan datos de ruta para validación de precio");
        allGood = false;
      }
    }
  }
  
  // VALIDACIÓN DE DATOS INTERNOS (lPDet)
  console.log("\n📊 VALIDACIÓN DE DATOS INTERNOS:");
  if (lPDet && typeof lPDet === 'object') {
    console.log("   ✅ Objeto lPDet existe");
    console.log("   Total interno:", lPDet.total ? "$" + lPDet.total.toFixed(2) : "❌ No definido");
    
    if (lPDet.total && checkoutPrice) {
      const internalConsistent = Math.abs(lPDet.total - checkoutPrice) < 0.01;
      console.log("   ✅ Consistencia interna:", internalConsistent ? "SÍ" : "❌ NO");
      
      if (!internalConsistent) {
        consistencyIssues.push(`Datos internos inconsistentes: lPDet $${lPDet.total.toFixed(2)} vs botón $${checkoutPrice.toFixed(2)}`);
        allGood = false;
      }
    }
    
    // Mostrar detalles de lPDet si están disponibles
    if (lPDet.details) {
      console.log("   📋 Detalles disponibles:");
      console.log("     Horas:", lPDet.details.hours || "N/A");
      console.log("     Tarifa por hora:", lPDet.details.hourlyRate ? "$" + lPDet.details.hourlyRate.toFixed(2) : "N/A");
      console.log("     Millas:", lPDet.details.miles ? lPDet.details.miles.toFixed(2) : "N/A");
      console.log("     Minutos:", lPDet.details.totalMinutes || "N/A");
      console.log("     Tipo de vehículo:", lPDet.details.vehicleType || "N/A");
    }
  } else {
    console.log("   ❌ Objeto lPDet no existe o está vacío");
    consistencyIssues.push("Faltan datos internos de precio (lPDet)");
    allGood = false;
  }
  
  // VALIDACIÓN DEL CONTENEDOR DE PRECIO
  console.log("\n🖼️ VALIDACIÓN DE VISUALIZACIÓN:");
  if (priceContainer) {
    const hasContent = priceContainer.innerHTML.trim() !== "";
    const hasLoadingIndicator = priceContainer.innerHTML.includes("price-loading");
    const hasPriceDetails = priceContainer.innerHTML.includes("price-details");
    
    console.log("   Contenedor tiene contenido:", hasContent ? "✅ SÍ" : "❌ NO");
    console.log("   Mostrando indicador de carga:", hasLoadingIndicator ? "⏳ SÍ" : "✅ NO");
    console.log("   Mostrando detalles de precio:", hasPriceDetails ? "✅ SÍ" : "❌ NO");
    
    if (!hasContent) {
      consistencyIssues.push("Contenedor de precio está vacío");
      allGood = false;
    }
    
    if (hasLoadingIndicator) {
      consistencyIssues.push("Precio aún se está calculando (mostrando indicador de carga)");
      allGood = false;
    }
  } else {
    console.log("   ❌ Contenedor de precio no encontrado");
    consistencyIssues.push("Contenedor de precio no encontrado en DOM");
    allGood = false;
  }
  
  // VALIDACIÓN DE FUNCIONES NECESARIAS
  console.log("\n🔧 VALIDACIÓN DE FUNCIONES:");
  const requiredFunctions = [
    'getOptimalDepartureTime',
    'cRD',
    'cTP',
    'updateFixedHourlyPrice',
    'dMU'
  ];
  
  requiredFunctions.forEach(functionName => {
    const exists = typeof window[functionName] === 'function';
    console.log(`   ${functionName}:`, exists ? "✅ OK" : "❌ FALTA");
    if (!exists) {
      consistencyIssues.push(`Función ${functionName} no encontrada`);
      allGood = false;
    }
  });
  
  // VALIDACIÓN DE VARIABLES GLOBALES
  console.log("\n🌐 VALIDACIÓN DE VARIABLES GLOBALES:");
  console.log("   routeData:", routeData ? "✅ Disponible" : "❌ No disponible");
  console.log("   selectedDepartureTime:", window.selectedDepartureTime ? "✅ Configurado" : "⚠️ No configurado");
  console.log("   PR (tarifas):", typeof PR === 'object' ? "✅ Disponible" : "❌ No disponible");
  
  if (!routeData && (bookingType === "transfer" || bookingType === "point-to-point")) {
    consistencyIssues.push("routeData no disponible para tipo de reserva que requiere ruta");
    allGood = false;
  }
  
  // RESUMEN FINAL
  console.log("\n" + "=".repeat(50));
  console.log("🎯 RESUMEN DE VALIDACIÓN:");
  console.log("   Estado general:", allGood ? "✅ TODO CORRECTO" : "❌ PROBLEMAS ENCONTRADOS");
  console.log("   Número de problemas:", consistencyIssues.length);
  
  if (consistencyIssues.length > 0) {
    console.log("\n🚨 PROBLEMAS ENCONTRADOS:");
    consistencyIssues.forEach((issue, index) => {
      console.log(`   ${index + 1}. ${issue}`);
    });
    
    console.log("\n💡 RECOMENDACIONES:");
    if (consistencyIssues.some(issue => issue.includes("vehículo"))) {
      console.log("   • Selecciona un vehículo antes de continuar");
    }
    if (consistencyIssues.some(issue => issue.includes("ruta"))) {
      console.log("   • Completa la información de pickup y dropoff");
      console.log("   • Espera a que se calculen los datos de ruta");
    }
    if (consistencyIssues.some(issue => issue.includes("función"))) {
      console.log("   • Verifica que todas las funciones necesarias están implementadas");
    }
    if (consistencyIssues.some(issue => issue.includes("botón"))) {
      console.log("   • Ejecuta updateFixedHourlyPrice() o dMU() para recalcular");
    }
  } else {
    console.log("\n🎉 ¡EXCELENTE! Todos los precios están sincronizados correctamente.");
  }
  
  console.log("=".repeat(50));
  
  // Retornar objeto con resultados para uso programático
  return {
    isConsistent: allGood,
    issues: consistencyIssues,
    bookingType: bookingType,
    checkoutPrice: checkoutPrice,
    hasRouteData: !!routeData,
    hasVehicleSelected: !!document.querySelector('.vehicle.selected'),
    lPDetExists: !!(lPDet && lPDet.total)
  };
}

function validateTimeSync() {
  console.log("=== ✅ VALIDACIÓN DE SINCRONIZACIÓN ===");
  
  // Verificar que las funciones nuevas existen
  const functionsToCheck = [
    'getOptimalDepartureTime',
    'buildOptimizedMapSrc',
    'debugTimeComparison'
  ];
  
  let allFunctionsExist = true;
  functionsToCheck.forEach(funcName => {
    if (typeof window[funcName] === 'function') {
      console.log("✅", funcName, "- OK");
    } else {
      console.log("❌", funcName, "- NO ENCONTRADA");
      allFunctionsExist = false;
    }
  });
  
  // Verificar variables globales
  console.log("📊 Variables globales:");
  console.log("   routeData:", routeData ? "Disponible" : "No disponible");
  console.log("   selectedDepartureTime:", window.selectedDepartureTime ? "Configurado" : "No configurado");
  
  // Estado de elementos DOM
  const mapFrame = document.getElementById("map-frame");
  const priceContainer = document.getElementById("price-breakdown");
  
  console.log("🖼️ Elementos DOM:");
  console.log("   Map frame:", mapFrame ? "OK" : "No encontrado");
  console.log("   Price container:", priceContainer ? "OK" : "No encontrado");
  
  if (allFunctionsExist) {
    console.log("🎉 TODAS LAS FUNCIONES INSTALADAS CORRECTAMENTE");
  } else {
    console.log("⚠️ FALTAN ALGUNAS FUNCIONES - Revisar instalación");
  }
  
  console.log("=====================================");
  
  return allFunctionsExist;
}

// Ejecutar validación automáticamente
window.validateTimeSync = validateTimeSync;

// Ejecutar después de que se cargue todo
setTimeout(() => {
  if (typeof validateTimeSync === 'function') {
    validateTimeSync();
  }
}, 2000);
</script>
</head>
<body>
  <div class="container">
    <div class="column booking-column">
      <form class="booking-form" action="https://formspree.io/f/xldgvzlo" method="POST" id="booking-form">
        <input type="hidden" name="booking_details" id="booking-details">
        <input type="hidden" name="booking_type" id="booking-type" value="transfer">
        <input type="hidden" name="_subject" value="New Airport Transfer Booking - Jrod Transportation">
        <input type="hidden" name="_to" value="info@jrodtransportation.com">
        <div class="booking-type-selector">
            <button type="button" class="booking-type-btn" id="transfer-btn" onclick="sBT('transfer')">AIRPORT TRANSFER</button>
            <button type="button" class="booking-type-btn" id="point-btn" onclick="sBT('point-to-point')">POINT-TO-POINT</button>
            <button type="button" class="booking-type-btn" id="hourly-btn" onclick="sBT('hourly')">HOURLY</button>
        </div>        
        <div id="trip-type-container" class="form-group full-width" style="display:none;">
          <label for="trip-type">Trip Type:</label>
          <select id="trip-type" name="trip-type" onchange="toggleTripType()">
            <option value="one-way">One Way</option><option value="round-trip">Round Trip</option>
          </select>
        </div>
        <input type="hidden" id="location-type" name="location-type" value="all">
        <div id="duration-container" class="duration-container" style="display:none;">
          <div class="duration-row">
            <div class="duration-field">
              <label for="trip-hours"><i class="far fa-clock"></i> Trip Duration</label>
              <div class="duration-input-group">
                <button type="button" class="duration-btn" id="decrease-btn" onclick="adjustDuration(-1)"><i class="fas fa-minus"></i></button>
                <input type="text" id="trip-hours" class="duration-input" value="1" readonly>
                <button type="button" class="duration-btn" id="increase-btn" onclick="adjustDuration(1)"><i class="fas fa-plus"></i></button>
              </div>
            </div>
          </div>
          <div class="duration-display"><i class="fas fa-hourglass-half"></i> Selected duration: <span id="hours-display">1</span> hour(s)</div>
        </div>
        <div class="form-group">
          <label for="pickup-date">Pickup Date:</label><input type="date" id="pickup-date" name="pickup-date" required>
        </div>
        <div class="form-group">
          <label for="pickup-time">Pickup Time:</label><input type="time" id="pickup-time" name="pickup-time" required>
        </div>
        <div class="form-group full-width" id="pickup-container">
          <label for="pickup">Pickup Point: <span id="airport-pickup-indicator" style="display:none; color:#4CAF50; font-weight:normal;"></span></label>
          <input type="text" id="pickup" name="pickup" class="autocomplete" required>
        </div>
        <div class="form-group full-width" id="dropoff-container">
          <label for="dropoff">Drop-off Point: <span id="airport-dropoff-indicator" style="display:none; color:#4CAF50; font-weight:normal;"></span></label>
          <input type="text" id="dropoff" name="dropoff" class="autocomplete" required>
        </div>
        <div class="form-group full-width" id="add-stop-container" style="display:none;">
            <label for="add-stop">Additional Stops:</label>
            <div id="stops-container"></div>
            <button type="button" onclick="addStop()">Add Stop</button>
        </div>
        <div id="airport-fields" class="full-width" style="display:none;">
          <div id="flight-type-container" class="form-group full-width" style="display:none;">
            <label for="flight-type">Flight Type:</label>
            <select id="flight-type" name="flight-type" onchange="tFF()">
              <option value="" disabled selected>Select Flight Type</option>
              <option value="arrival">Arrival</option><option value="departure">Departure</option>
            </select>
          </div>
        <div id="arrival-fields" style="display:none;">
            <div class="form-group"><label for="airline">Airline (required for airport pickup):</label><input type="text" id="airline" name="airline"></div>
            <div class="form-group"><label for="flight">Flight Number (required for airport pickup):</label><input type="text" id="flight" name="flight"></div>
            <div class="form-group"><label for="arrival-time">Arrival Time:</label><input type="time" id="arrival-time" name="arrival-time"></div>
          </div>
          <div id="departure-fields" style="display:none;">
            <div class="form-group"><label for="dep-airline">Airline (required for airport dropoff):</label><input type="text" id="dep-airline" name="dep-airline"></div>
            <div class="form-group"><label for="dep-flight">Flight Number (required for airport dropoff):</label><input type="text" id="dep-flight" name="dep-flight"></div>
            <div class="form-group"><label for="departure-time">Departure Time:</label><input type="time" id="departure-time" name="departure-time"></div>
          </div>
        </div>
        <div class="form-group" id="passengers-container">
            <label for="passengers">Passengers:</label><input type="number" id="passengers" name="passengers" min="1" value="1">
          </div> 
          <div class="form-group" id="kids-container">
            <label for="kids">Kids:</label><input type="number" id="kids" name="kids" min="0" value="0">
          </div>
        <div class="form-group" id="luggage-container">
            <label for="luggage">Luggage:</label><input type="number" id="luggage" name="luggage" min="0" value="0">
        </div>
        <div class="form-group">
          <label for="phone">Phone Number:</label><input type="tel" id="phone" name="phone" pattern="[0-9]{10}" placeholder="Enter 10-digit number" required>
        </div>
        <div class="form-group full-width">
          <label for="email">Email:</label><input type="email" id="email" name="email" required>
        </div>
        <div class="form-group">
          <label for="first-name">First Name:</label><input type="text" id="first-name" name="first_name" required>
        </div>
        <div class="form-group">
          <label for="last-name">Last Name:</label><input type="text" id="last-name" name="last_name" required>
        </div>
        <div id="transfer-special-request-container" class="full-width">
          <label for="transfer-special-request">Special Request (Airport Transfer):</label>
          <textarea id="transfer-special-request" name="transfer_special_request" placeholder="Enter any special requests for your airport transfer..."></textarea>
        </div>
        <div id="hourly-itinerary-container" class="full-width" style="display:none;">
          <label for="hourly-itinerary">Itinerary Details (Hourly Only):</label>
          <textarea id="hourly-itinerary" name="hourly_itinerary" placeholder="Describe your itinerary here..."></textarea>
        </div>
        <button type="button" onclick="sV()">Continue</button>
        <div id="vehicle-section" class="hidden vehicle-selection">
          <h2 style="color:white;">Select Your Vehicle</h2>
          <div class="vehicle" id="toyota" onclick="sV2('toyota')">
            <img src="https://cdn.prod.website-files.com/67bddfd2a3c844b17c688a52/67bddfd2a3c844b17c688b1e_Vehiculos%20(1).png" alt="Toyota Tundra">
            <span>Premium Sedan</span><span class="price" id="toyota-price"></span>
          </div>
          <div class="vehicle" id="cadillac" onclick="sV2('cadillac')">
            <img src="https://cdn.prod.website-files.com/678ac38b1f7c98624f37a131/67b9871b16217532ab8642f9_Cadillac%20Escalade%20ESV.jpeg" alt="Cadillac Escalade ESV">
            <span>Premium SUV</span><span class="price"></span>
          </div>
          <div><button type="button" id="checkout-button" class="hidden" onclick="hS(event)">Check Out</button></div>
        </div>
        <div id="price-breakdown"></div><div id="fixed-hourly-price" class="price-details" style="display:none; margin-top:15px;">
          <h3><i class="fas fa-file-invoice-dollar"></i> Hourly Rate</h3>
          <div class="price-item">
            <span><i class="far fa-clock"></i> <span id="fixed-hours-display">3</span> hour(s) × $<span id="fixed-rate">95.00</span>/hour:</span>
            <span>$<span id="fixed-price">285.00</span></span>
          </div>
          <div class="price-item total">
            <span><i class="fas fa-money-check-alt"></i> Total:</span>
            <span>$<span id="fixed-total">285.00</span></span>
          </div>
        </div>
        <div id="sm" style="display:none;">Your booking has been successfully submitted. Processing payment...</div>
      </form>
    </div>
    <div class="column right-container">
      <div id="map-container">
        <iframe id="map-frame" src="about:blank" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        <div id="map-loading"><div id="map-spinner"></div></div>
      </div>
    </div>
  </div>
  <div id="lo"><div class="loader"></div></div>
  <div id="redir">
    <h2><i class="fas fa-check-circle"></i> Payment Successful!</h2>
    <p>Your booking has been confirmed and payment processed successfully.</p>
    <p>You will be automatically redirected to the confirmation page in a moment.</p>
    <button onclick="gSP()">Complete Booking Now</button>
  </div>
</body>
</html>
